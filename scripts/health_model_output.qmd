---
title: "Health output visualisation"
author: "Ali Abbas"
format: html
editor: source
---

```{r}
require(tidyverse)
require(esquisse)
require(here)

synth_pop <- read_csv(here("jibe health/base_pp_exposure_RR_2021.csv"))

zones <- read_csv(here("jibe health/zoneSystem.csv"))

zones <- zones |> distinct(ladnm, ladcd)

synth_pop <- synth_pop |> arrange(id)

m <- arrow::open_dataset(sources = here("data/full_sim_with_disease_inter.parquet"))

m <- m |> collect() |> as.data.frame() |> tibble::rowid_to_column("rid")

#m <- m |> as.data.frame() |> tibble::rowid_to_column("rid")

m <- m |> cbind(synth_pop |> select(id, age, gender, ladcd, lsoa21cd))

dc <- m |> pivot_longer(cols = starts_with("c")) |> 
    mutate(unpacked = str_split(value, " ")) |> 
    unnest() |> 
    mutate(value = str_trim(unpacked)) |> 
    dplyr::select(-unpacked) |> 
  # |> 
  group_by(ladcd, name, value) |> 
  summarise(count = dplyr::n()) |> 
  mutate(freq = round(count / sum(count) * 100, 1)) |> 
  filter(value != "healthy") |> 
  left_join(zones)

plotly::ggplotly(ggplot(dc) +
                   aes(x = freq, y = name, fill = value, group = value, colour = value) +
                   geom_bar(stat = "summary", fun = "sum", position = "dodge2") + 
                   geom_line() +
                   scale_fill_hue(direction = 1) +
                   coord_flip() +
                   theme_minimal() +
                   facet_wrap(vars(ladnm))
)

