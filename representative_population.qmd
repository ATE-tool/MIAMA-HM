---
title: "Representative Population"
author: "Belen Zapata-Diomedi, Steve Pemberton"
email: "mbzd2@cam.ac.uk, mb2592@cam.ac.uk, steve.pemberton@rmit.edu.au"
date: today
format: 
  html:
    code-fold: true
    embed-resources: true
    df-print: paged
    toc: true
    number-sections: true
execute: 
  echo: false
  message: false
  warning: false
editor_options:
  mode: visual
  markdown:
    wrap: 72
---

# Introduction

This document [generates a representative population of 10,100 people to
whom the health model will be applied].

```{r setup, include=FALSE}

rm(list = ls())

library(tidyverse)  # Includes dplyr, tidyr, readr, ggplot2, purrr, etc.
library(knitr)      # Report generation
library(gt)         # Pretty tables
library(here)       # File path management
library(haven)      # Read .dta files
library(Hmisc)      # Quantiles
library(drpa)       # Dose-response function

# Set root directory one level up from current directory
knitr::opts_knit$set(root.dir = dirname(getwd()))

# Avoid scientific notation
options("scipen"=100, "digits"=4)

```

# Base population

Base population is each combination of age (0 to 100), sex (male or female) and risk group (1 to 10, which will correspond to IMD deciles used in the health data). This base population will be joined below to 5 levels of physical activity, creating 5 scenarios.  In *[a subsequent step/the health model]*, each original individual will be replicated 1000 times.

```{r base-pop}
# age, sex and risk group (which will correspond to IMD decile)
rep_pop_base <- crossing(
  # age, sex and risk group
  age = 0:100,
  sex = c("male", "female"),
  risk_group = 1:10
) %>%
  # id for each base individual, as first column
  mutate(id_base = row_number()) %>%
  relocate(id_base)

```


# MMETs values

The synthetic population of approx 3 million people, with their physical activity details (walking, cycling and sport), is used to calculate Marginal Metabolic Equivalent of Tasks (MMET) values.

```{r calculate-mmets}

# load synthetic population
sp <- read_dta(here("synthetic_pop/SPindivid_CensusNTSALS.dta"))

# calculate mMETs for synthetic population
# see https://github.com/StevePem/that-brisbane/blob/master/Scripts/data_prep/mmet_pp.R for values
MMET_WALKING <- 2.5
MMET_CYCLING <- 5.8
MMET_VIG <- 7


sp_mmets <- sp %>%
  # assume 0 sport_wkhr for under age 5 (shown as NA)
  mutate(sport_wkhr = ifelse(sport_wkhr < 0 | is.na(sport_wkhr), 0, sport_wkhr)) %>%
  # calculate mmets
  mutate(mmets = walktime_wkhr * MMET_WALKING + cycletime_wkhr * MMET_CYCLING + sport_wkhr * MMET_VIG,
         sex = as.factor(ifelse(female == 1, "Females", "Males"))) %>%
  # keep required fields
  dplyr::select(census_id, sex, age1year, mmets)
```

The following plots show the distribution of the MMET values by age and sex.

```{r plot-mmets-distrib}

# plot the densities
# 1. Bin ages into 10-year groups and factorize
sp_mmets_binned <- sp_mmets %>%
  filter(!is.na(mmets)) %>%
  mutate(
    age_group = cut(
      age1year,
      breaks = c(seq(0, 80, by = 10), 90),
      labels = c("0-9","10-19","20-29","30-39","40-49","50-59","60-69","70-79","80-89"),
      include.lowest = TRUE,
      right = FALSE
    ),
    age_group = factor(age_group, levels = c("0-9","10-19","20-29","30-39","40-49","50-59","60-69","70-79","80-89"))
  )

# 2. Calculate percentiles per sex
percentiles <- sp_mmets_binned %>%
  group_by(sex) %>%
  summarise(
    p25  = quantile(mmets, 0.25, na.rm = TRUE),
    p50  = quantile(mmets, 0.50, na.rm = TRUE),
    p75  = quantile(mmets, 0.75, na.rm = TRUE),
    p95  = quantile(mmets, 0.95, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_longer(cols = starts_with("p"), names_to = "percentile", values_to = "mmets") %>%
  mutate(label = case_when(
    percentile == "p25" ~ "25th",
    percentile == "p50" ~ "50th",
    percentile == "p75" ~ "75th",
    percentile == "p95" ~ "95th"
  ))

# 3. Compute max density per sex for placing labels
max_density_per_sex <- sp_mmets_binned %>%
  group_by(sex) %>%
  do({
    dens <- density(.$mmets, adjust = 1.5)
    data.frame(max_density = max(dens$y))
  }) %>%
  distinct()

# 4. Plot densities with log1p x-axis
p_mmets_percentiles <- ggplot(sp_mmets_binned, 
                              aes(x = mmets, y = after_stat(density), color = age_group, group = age_group)) +
  geom_density(alpha = 0.4, linewidth = 0.7, adjust = 1.5) +
  facet_wrap(~ sex) +
  scale_color_viridis_d(option = "C", 
                        name = "Age group (years)",
                        guide = guide_legend(nrow = 2, byrow = TRUE)) +
  scale_x_continuous(trans = "log1p",  
                     breaks = c(0, 1, 10, 50),
                     labels = c(0, 1, 10, 50)) +
  labs(
    x = "MMETs (hrs/week, log1p scale)",
    y = "Density",
    title = "Distribution of MMETs by 10-year Age Group and Sex"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    strip.text = element_text(face = "bold"),
    legend.position = "bottom",
    panel.grid.major.x = element_blank(),  # remove vertical gridlines
    panel.grid.minor.x = element_blank()
  ) +
  # Add percentile lines without legend
  geom_vline(data = percentiles, aes(xintercept = mmets), 
             color = "grey40", linewidth = 0.7, linetype = "dashed") +
  # Add percentile labels above the densities
  geom_text(data = percentiles,
            aes(x = mmets, y = 0.9, label = label),
            inherit.aes = FALSE,
            angle = 90, vjust = -0.5, hjust = 0,
            size = 3,
            color = "grey20")

print(p_mmets_percentiles)

```

A set of 5 MMETs values for each age and sex combination is calculated. The values used are the middle of the quintile values, ie the 10th, 30th, 50th, 70th and 90th percentile. *The selection of these values may be considered further.*

```{r mmets-values}

# mMETs quintiles (altered above to convert NA sport_wkhr (for age < 5) to zeros)
mmets_pp <- sp_mmets %>%  
  rename(age = age1year) %>%
  mutate(sex = case_when(sex == "Females" ~ "female",
                         sex == "Males" ~ "male")) %>%
  
  # calculate quintiles
  group_by(sex, age) %>%
  summarise(percentile_10 = quantile(mmets, probs = 0.1, na.rm = TRUE),
            percentile_30 = quantile(mmets, probs = 0.3, na.rm = TRUE),
            percentile_50 = quantile(mmets, probs = 0.5, na.rm = TRUE),
            percentile_70 = quantile(mmets, probs = 0.7, na.rm = TRUE),
            percentile_90 = quantile(mmets, probs = 0.9, na.rm = TRUE)) %>%
  ungroup() %>%
  
  # expand the age sequence to include 90–100 for each sex
  complete(sex, age = 0:100) %>%
  
  # assume mMETs is zero for ave > 90
  mutate(across(starts_with("percentile"),
                ~ if_else(age > 89, 0, .x))) %>%

  # pivot longer to produce one row per qunitile
  pivot_longer(
    cols = starts_with("percentile_"),
    names_to = "mmets_group",
    values_to = "mmets"
  ) %>%
  mutate(mmets_group = factor(mmets_group, 
                         levels = paste0("percentile_", c(10,30,50,70,90)))) 

```

# Calculate physical activity relative risks

The physical activity relative risks are calculated based on the MMETs values, using the `drpa` package.  As a deterministic method of calculating the values is used, these risks need only be calculated once for each base individual (rather than for each individual's 1000 replications).

```{r pa-risks}

# list of disease names
diseases <- read.csv(here("health_data/processed/health_transitions.csv")) %>%
  pull(cause) %>%
  unique() %>%
  # update names to match drpa requirements
  str_replace_all("_", "-") %>%
  str_replace_all("’", "'")


# assign relative risks
for (i in seq_along(diseases)) {
  
  disease <- diseases[i]
  new_colname <- paste0("rr_PHYSICAL_ACTIVITY_", disease)
  
  mmets_pp[[new_colname]] <- 
    ifelse(!(mmets_pp$sex == "male" & disease %in% c("breast-cancer", "endometrial-cancer")),
           # calculate the dose response except for male breast/endometrial cancer
           drpa::dose_response(
             cause = disease,
             outcome_type = ifelse(disease == "diabetes", "non-fatal", "fatal-and-non-fatal"),
             dose = mmets_pp$mmets,
             quantile = 0.5,  # deterministic
             censor_method = "75thPercentile",
             confidence_intervals = FALSE
           )$rr, 
           # assign 1 for male breast/endometrial cancer
           1)
  
}

```

# Representative population with PA risks

The physical activity risks, for each of the MMETS values, are joined to the base representative population, to create the output representative population*[, and replicated by 1000. / . The representative population will be replicated by 1000 in the health model.]*

```{r rep-pop}

# join mmets 
rep_pop <- rep_pop_base %>%
  
  # join the mmets values
  left_join(mmets_pp, by = c("age", "sex"), relationship = "many-to-many")

# save output
write.csv(rep_pop, here("health_data/processed/rep_pop.csv"), row.names = FALSE)


# Replication code (for the health model)

# number of times to replicate each original individual
replic_no <- 1000

# replication with id
synth_pop <- rep_pop %>%
  
  # replicate each base individual 1000×
  slice(rep(1:n(), each = replic_no)) %>%
  
  # create a unique replicate index per base individual
  group_by(id_base) %>%
  mutate(rep_index = rep(1:replic_no, times = n() / replic_no)) %>%
  ungroup() %>%
  
  # assign a unique ID per replicated individual
  # all mmets_group rows of the same replicate share the same ID
  group_by(id_base, rep_index) %>%
  mutate(id = cur_group_id()) %>%
  ungroup() %>%
  
  #  move id to the front, drop temporary columns
  relocate(id) %>%
  select(-rep_index)

```

# Assign initial disease state based on prevalence

UP TO HERE
