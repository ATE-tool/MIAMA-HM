---
title: "Health Data Manchester"
author: "Marina Berdikhaniva, Belen Zapata-Diomedi"
email: "mbzd2@cam.ac.uk, mb2592@cam.ac.uk"
date: today
format: 
  html:
    code-fold: true
    embed-resources: true
    df-print: paged
execute: 
    message: false
    warning: false
toc: true
number-sections: true
editor_options:
  mode: visual
  markdown:
    wrap: 72
---s
---

# Introduction

This document explains and produces estimates for the inputs for the
health model for JIBE Manchester. The model initially has four stages
where individuals are in a healthy state, might become diseased of one
or more diseases, and die from any causes (all cause mortality). All
cause mortality is also dependent on diseases statues, meaning that if a
person has a given disease (i.e. diabetes, dementia, parkinson, cancers,
copd) their probability of dying is higher. Diabetes is a risk factor
for cardiovascular diseases (ischemic heart disease and stroke) and
included in the model. The model does not include trend of diseases but
assumes that current rates by age, sex and area will be observed in the
future.

The purpose of this document is to produce health inputs for all-cause
mortality and diseases' incidence and prevalence. Prevalence is used to
assign initial state as diseased.

```{r setup, include=FALSE}

rm(list = ls())

library(tidyverse)  # Includes dplyr, tidyr, readr, ggplot2, purrr, etc.
library(readxl)   # Read/write Excel files
library(knitr)      # Report generation
library(gt)         # Pretty tables
library(here)       # File path management
library(base)       # Read RDS files
library(plotly)     # Interactive plots
library(htmlwidgets)# Save interactive plots
# Set root directory one level up from current directory
knitr::opts_knit$set(root.dir = dirname(getwd()))

# Functions
source("functions/interpolation.R") 
source("functions/gbd_process.R")


# Avoid scientific notation
options("scipen"=100, "digits"=4)

knitr::opts_chunk$set(
  echo = FALSE,          # Hide code by default
  message = FALSE,       # Suppress messages
  warning = FALSE)        # Suppress warnings
```

# All-Cause Mortality

## Data Sources

1.  Mortality by LSOA by age and sex for year 2018 from ONS.
    [https://www.ons.gov.uk/peoplepopulationandcommunity/birthsdeathsandmarriages/deaths/adhocs/](https://www.ons.gov.uk/peoplepopulationandcommunity/birthsdeathsandmarriages/deaths/adhocs/1028deathregistrationsbysexfiveyearagegroupandlowerlayersuperoutputareaslsoa2011censusboundariesenglandandwales2001to2021)

    [1028deathregistrationsbysexfiveyearagegroupandlowerlayersuperoutputareaslsoa2011censusboundariesenglandandwales2001to2021](https://www.ons.gov.uk/peoplepopulationandcommunity/birthsdeathsandmarriages/deaths/adhocs/1028deathregistrationsbysexfiveyearagegroupandlowerlayersuperoutputareaslsoa2011censusboundariesenglandandwales2001to2021)

2.  Population Data by LSOA by age and sex for 2018 mid year from ONS.

    [https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/](https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/lowersuperoutputareamidyearpopulationestimates)

    [lowersuperoutputareamidyearpopulationestimates](https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/lowersuperoutputareamidyearpopulationestimates)

3.  Geographical Hierarchy (as of 2011)

    <https://geoportal.statistics.gov.uk/datasets/ons::lsoa-2011-to-travel-to-work-area-december-2011-exact-fit-lookup-in-the-uk/about>

4.  Life tables England (2017-2019)

    [https://www.ons.gov.uk/peoplepopulationandcommunity/birthsdeathsandmarriages/lifeexpectancies/](https://www.ons.gov.uk/peoplepopulationandcommunity/birthsdeathsandmarriages/lifeexpectancies/datasets/nationallifetablesenglandreferencetables/current)

    [datasets/nationallifetablesenglandreferencetables/current](https://www.ons.gov.uk/peoplepopulationandcommunity/birthsdeathsandmarriages/lifeexpectancies/datasets/nationallifetablesenglandreferencetables/current)

5.  Level of multiple deprivation

    <https://opendatacommunities.org/resource?uri=http%3A%2F%2Fopendatacommunities.org%2Fdata%2Fsocietal-wellbeing%2Fimd2019%2Findices>

6.  Adding Age-Standartised Mortality Rates from ONS as of February,
    2025

    <https://opendatacommunities.org/resource?uri=http%3A%2F%2Fopendatacommunities.org%2Fdata%2Fsocietal-wellbeing%2Fimd2019%2Findices>

```{r data-prep}

# Mortality by LSOA by age and sex (Year: 2018) 
# [Source]: https://www.ons.gov.uk/peoplepopulationandcommunity/birthsdeathsandmarriages/deaths/adhocs/1028deathregistrationsbysexfiveyearagegroupandlowerlayersuperoutputareaslsoa2011censusboundariesenglandandwales2001to2021

# Import data from ONS
deaths_males <- read_xlsx(
  here("manchester/health/original/ons", "DeathsbyLSOAmidyear11to21.xlsx"),
  sheet = "2",
  skip = 2
)
deaths_females <- read_xlsx(
  here("manchester/health/original/ons", "DeathsbyLSOAmidyear11to21.xlsx"),
  sheet = "3",
  skip = 2
)


# Filter for 2018
deaths_males <- deaths_males %>% 
  filter(`Mid-year` %in% c(2018))
deaths_females <- deaths_females %>% 
  filter(`Mid-year` %in% c(2018))

# Merge Males and Females data
deaths <- merge(deaths_males, deaths_females, by = c("LSOA code"))

rm(deaths_males, deaths_females)

# Reshape the data
deaths <- deaths %>%
  pivot_longer(cols = c(starts_with("Males"), starts_with("Females")),  
               names_to = c("gender", "age"),                          
               names_pattern = "(Males|Females) (.+)",                 
               values_to = "deaths")

# Final data clean up 
deaths_england <- deaths %>% 
  filter(!str_starts(`LSOA code`, "W")) %>% # Remove Wales
  select(
    lsoa_code = `LSOA code`,                     
    lsoa_name = `LSOA name.x`,                   
    gender,                
    age,
    deaths) %>% 
  mutate(age = case_when(
    age %in% c("under 1", "01 to 04") ~ "00 to 04", 
    TRUE ~ age
  )) %>%
  group_by(lsoa_code, lsoa_name, age, gender) %>%
  summarize(deaths = sum(deaths),.groups = "drop") %>%
  ungroup()

rm(deaths)
 
# Population Data by LSOA by age and sex (Year: 2018)
#[Source]: https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/lowersuperoutputareamidyearpopulationestimates

pop_males <- read_xlsx(
  here("manchester/health/original/ons", "SAPE21DT1a-mid-2018-on-2019-LA-lsoa-syoa-estimates-formatted.xlsx"),
  sheet = "Mid-2018 Males", 
  skip = 3
)

pop_females <- read_xlsx(
  here("manchester/health/original/ons", "SAPE21DT1a-mid-2018-on-2019-LA-lsoa-syoa-estimates-formatted.xlsx"),
  sheet = "Mid-2018 Females", 
  skip = 3
)

# Males

# Remove Wales
pop_males <- pop_males %>% 
  filter(LSOA != '', !str_starts(`Area Codes`,"W")) %>% 
  rename("lsoa_name" = "LSOA",
         "lsoa_code" = "Area Codes") %>% 
  select(-c(2, 4))

# Create age groups
pop_males <- pop_males %>% 
  mutate(
    `00 to 04` = rowSums(select(pop_males, `0`,`1`, `2`, `3`, `4`), na.rm = TRUE),
    `05 to 09` = rowSums(select(pop_males, `5`, `6`, `7`, `8`, `9`), na.rm = TRUE),
    `10 to 14` = rowSums(select(pop_males, `10`, `11`, `12`, `13`, `14`), na.rm = TRUE),
    `15 to 19` = rowSums(select(pop_males, `15`, `16`, `17`, `18`, `19`), na.rm = TRUE),
    `20 to 24` = rowSums(select(pop_males, `20`, `21`, `22`, `23`, `24`), na.rm = TRUE),
    `25 to 29` = rowSums(select(pop_males, `25`, `26`, `27`, `28`, `29`), na.rm = TRUE),
    `30 to 34` = rowSums(select(pop_males, `30`, `31`, `32`, `33`, `34`), na.rm = TRUE),
    `35 to 39` = rowSums(select(pop_males, `35`, `36`, `37`, `38`, `39`), na.rm = TRUE),
    `40 to 44` = rowSums(select(pop_males, `40`, `41`, `42`, `43`, `44`), na.rm = TRUE),
    `45 to 49` = rowSums(select(pop_males, `45`, `46`, `47`, `48`, `49`), na.rm = TRUE),
    `50 to 54` = rowSums(select(pop_males, `50`, `51`, `52`, `53`, `54`), na.rm = TRUE),
    `55 to 59` = rowSums(select(pop_males, `55`, `56`, `57`, `58`, `59`), na.rm = TRUE),
    `60 to 64` = rowSums(select(pop_males, `60`, `61`, `62`, `63`, `64`), na.rm = TRUE),
    `65 to 69` = rowSums(select(pop_males, `65`, `66`, `67`, `68`, `69`), na.rm = TRUE),
    `70 to 74` = rowSums(select(pop_males, `70`, `71`, `72`, `73`, `74`), na.rm = TRUE),
    `75 to 79` = rowSums(select(pop_males, `75`, `76`, `77`, `78`, `79`), na.rm = TRUE),
    `80 to 84` = rowSums(select(pop_males, `80`, `81`, `82`, `83`, `84`), na.rm = TRUE),
    `over 85` = rowSums(select(pop_males, `85`:`89`, `90+`), na.rm = TRUE)
  ) %>%
  select(`lsoa_code`, lsoa_name, `00 to 04`, `05 to 09`, `10 to 14`, `15 to 19`, `20 to 24`, `25 to 29`, `30 to 34`, 
         `35 to 39`, `40 to 44`, `45 to 49`, `50 to 54`, `55 to 59`, `60 to 64`, `65 to 69`, 
         `70 to 74`, `75 to 79`, `80 to 84`, `over 85`)

# Reshape the data
pop_males <- pop_males %>%
  pivot_longer(
    cols = -c(lsoa_name, lsoa_code),
    names_to = "age",        
    values_to = "population") %>% 
  mutate(gender = "Males")

# Females 

# Remove Wales
pop_females <- pop_females %>% 
  filter(LSOA != '', !str_starts(`Area Codes`,"W")) %>% 
  rename("lsoa_name" = "LSOA",
         "lsoa_code" = "Area Codes") %>% 
  select(-c(2, 4))

pop_females <- pop_females %>% 
  mutate(
    `00 to 04` = rowSums(select(pop_females, `0`,`1`, `2`, `3`, `4`), na.rm = TRUE),
    `05 to 09` = rowSums(select(pop_females, `5`, `6`, `7`, `8`, `9`), na.rm = TRUE),
    `10 to 14` = rowSums(select(pop_females, `10`, `11`, `12`, `13`, `14`), na.rm = TRUE),
    `15 to 19` = rowSums(select(pop_females, `15`, `16`, `17`, `18`, `19`), na.rm = TRUE),
    `20 to 24` = rowSums(select(pop_females, `20`, `21`, `22`, `23`, `24`), na.rm = TRUE),
    `25 to 29` = rowSums(select(pop_females, `25`, `26`, `27`, `28`, `29`), na.rm = TRUE),
    `30 to 34` = rowSums(select(pop_females, `30`, `31`, `32`, `33`, `34`), na.rm = TRUE),
    `35 to 39` = rowSums(select(pop_females, `35`, `36`, `37`, `38`, `39`), na.rm = TRUE),
    `40 to 44` = rowSums(select(pop_females, `40`, `41`, `42`, `43`, `44`), na.rm = TRUE),
    `45 to 49` = rowSums(select(pop_females, `45`, `46`, `47`, `48`, `49`), na.rm = TRUE),
    `50 to 54` = rowSums(select(pop_females, `50`, `51`, `52`, `53`, `54`), na.rm = TRUE),
    `55 to 59` = rowSums(select(pop_females, `55`, `56`, `57`, `58`, `59`), na.rm = TRUE),
    `60 to 64` = rowSums(select(pop_females, `60`, `61`, `62`, `63`, `64`), na.rm = TRUE),
    `65 to 69` = rowSums(select(pop_females, `65`, `66`, `67`, `68`, `69`), na.rm = TRUE),
    `70 to 74` = rowSums(select(pop_females, `70`, `71`, `72`, `73`, `74`), na.rm = TRUE),
    `75 to 79` = rowSums(select(pop_females, `75`, `76`, `77`, `78`, `79`), na.rm = TRUE),
    `80 to 84` = rowSums(select(pop_females, `80`, `81`, `82`, `83`, `84`), na.rm = TRUE),
    `over 85` = rowSums(select(pop_females, `85`:`89`, `90+`), na.rm = TRUE)
  ) %>%
  select(`lsoa_code`, lsoa_name, `00 to 04`, `05 to 09`, `10 to 14`, `15 to 19`, `20 to 24`, `25 to 29`, `30 to 34`, 
         `35 to 39`, `40 to 44`, `45 to 49`, `50 to 54`, `55 to 59`, `60 to 64`, `65 to 69`, 
         `70 to 74`, `75 to 79`, `80 to 84`, `over 85`)

pop_females <- pop_females %>%
  pivot_longer(
    cols = -c(lsoa_name, lsoa_code),
    names_to = "age",        
    values_to = "population") %>% 
  mutate(gender = "Females")

# Combine Males and Females

population_england <- bind_rows(pop_males, pop_females)

rm(pop_males, pop_females)

# Geographical Hierarchy (as of 2011)
# [Source]: https://geoportal.statistics.gov.uk/datasets/ons::lsoa-2011-to-travel-to-work-area-december-2011-exact-fit-lookup-in-the-uk/about

msoa <- read.csv(here('manchester/health/original/ons/lsoa_2011.csv'))

msoa <- msoa %>%
  select(2:7) %>%
  distinct()
# Columns: lsoa code, msoa code, lad code, lsoa name, msoa nmae, lad name

# Life Tables for England (2017-2019)
# [Source]: https://www.ons.gov.uk/peoplepopulationandcommunity/birthsdeathsandmarriages/lifeexpectancies/datasets/nationallifetablesenglandreferencetables/current
lifetable_england  <- read.csv(here('manchester/health/original/ons/life_tables_20172019.csv'),skip = 5)

# English Indices of Deprivation by LSOA (2019)
# [Source]: https://opendatacommunities.org/resource?uri=http%3A%2F%2Fopendatacommunities.org%2Fdata%2Fsocietal-wellbeing%2Fimd2019%2Findices
deprivation <- read_csv(here('manchester/health/original/ons/imd2019lsoa.csv')) 

# European Standard Population 2013
# [Source]: https://publichealthscotland.scot/services/national-data-catalogue/national-datasets/search-the-datasets/european-standard-population/#:~:text=The%20European%20Standard%20Population%20(ESP,was%20originally%20introduced%20in%201976.
european_pop <- read.csv(here('manchester/health/original/ons/european_standard_population_by_sex.csv'))

# Adding Age-Standartised Mortality Rates from ONS as of February, 2025 

nomis_lad <- read_xlsx(
here("manchester/health/original/ons/nomis_2025_02_21_lads_regions.xlsx"), 
     skip = 40, 
     n_max = 70) %>% 
  slice(c(1, 68)) %>% 
  select(-c(1, 12)) %>% 
  rename_with(~ str_remove(., "^lacu:")) %>% 
  mutate(gender = c("Males", "Females")) %>%
  pivot_longer(-gender, names_to = "lad_name", values_to = "stdrate_ons") %>%  
  mutate(stdrate_ons = as.numeric(stdrate_ons)/100)



```

## Mortality rates by year of age and sex for England

The mortality rate `mx` is defined as "the number of deaths at age x
last birthday in the three year period (2017-2019) divided by the
average population at that age over the same period. This is the
starting data to further expand by LSOAs based on the ratio of the
age-standardised mortality rates by sex for each LSOA relative to
England as a whole. ASDR are not publicly available at LSOA, therefore,
we calculated them.

```{r}

lifetable_england <- lifetable_england[, -c(3,7,8,10)] 

mf <- rep(c("male","female"),each=4)
names1 <- rep(c("rate","denom","deaths","le"), 2)
names(lifetable_england) <- c("age",paste(mf, names1, sep="_"))

lifetable_england <- lifetable_england %>% 
  mutate(male_personyears = round(male_denom - male_deaths),
         female_personyears = round(female_denom - female_deaths)) %>% 
  select(
    age, male_denom, male_rate, male_personyears, male_le,
    female_denom, female_rate, female_personyears, female_le)

england_lifetable <- lifetable_england |>
  pivot_longer(-age, 
               names_to = c("sex","measure"),
               names_sep = "_") |>
  pivot_wider(names_from="measure", values_from=value) |>
  mutate(rate1000 = rate*1000,
         sex = factor(sex,
                      labels=stringr::str_to_title(sort(unique(.data$sex)))),
         sex = relevel(sex, "Male"))
```

## Population weights for age groups and sex for England

To derive age-standardized rates for each LSOA by sex and then derive
ratios of mortality rate for LSOAs by sex, we need population weights
for our reference population of England. We constructed these weights
using population data for England. We also, further down the document,
construct ratios using European standard population for validation
purposes of data by LAD (for which there are publicly available ASDR by
LAD and sex).

```{r}
# Population weight for each age group within all lsoas in England. England is our reference population, since the RRs will then be multiplied by death rates by age and sex for the whole of England. 

# Calculate age-specific population and join with gender totals
population_england_total <- population_england %>% 
  group_by(age,gender) %>% 
  summarise(age_population = sum(population)) %>%
  ungroup()
  
population_gender_England <- population_england %>% 
  group_by(gender) %>% 
  summarise(gender_population = sum(population)) %>%
  ungroup

population_weights_England <- population_england_total %>%
  select(gender, age, age_population) %>%
  group_by(gender, age) %>%
  summarise(age_population = sum(age_population)) %>% 
  ungroup() %>%
  left_join(population_gender_England, by = "gender") %>% # Join with total population by gender
  mutate(weight=age_population/gender_population)
```

## Relative Risk by LSOA

A relative mortality rate is produced for each area (lsoa), defined as
the age-standardised mortality rate by sex for each lsoa relative to the
average mortality in England by sex**.**

The age-standardized mortality rate (ASMR) (direct standardization) by
sex and lsoa is calculated by first finding the age-specific (mortality)
rates for each age group (5 years) by dividing the number of deaths by
the respective population by sex, then multiplying the result by 1000,
then the sum of the product of each of the age-specific rates by the
proportion of the population belonging to the particular age group
(standard population weight) by area and sex. For England as a whole,
the average mortality is defined as a weighted average of the
area-specific rates, weighted by the population of each area.

For future reference (
[https://pmc.ncbi.nlm.nih.gov/articles/PMC9575652](https://pmc.ncbi.nlm.nih.gov/articles/PMC9575652/))
we might want to improve the calculation of ASDR.

We calculated ASDRs for lsoas, msoas and lads. While we want the
relative risks for each lsoa compared to England as a whole, some lsoa
have small deaths numbers, in those cases we replaced by msoas or lads
if msoas still had small numbers. We applied a rule that if less than 10
deaths in an age group in an lsoa, then a msoa ASDRs should be used, and
if more than 10 deaths but less than 20 in an MSOA, then use the LAD
ASDRs.

### LSOAs ASDRs by sex

```{r}

deaths_lsoa_eng <- merge(deaths_england, population_england, by = c("lsoa_code", "lsoa_name", "gender", "age"))

# Age-specific (mortality) rates

#check <- deaths_lsoa_eng %>%
#  filter(population == 0 & deaths > 0)

#length(unique(check$lsoa_code))

#326 unique LSOAs with 0 population
#100 cases removed where pop = 0, but deaths > 0 (98 unique LSOAs)
#Note: 674 cases when there are more deaths than population across age groups

# Remove cases when population is 0 but deaths are more than 0, assign 0 ASR

deaths_lsoa_eng <- deaths_lsoa_eng %>%
  filter(!(population == 0 & deaths > 0)) %>% 
  mutate(age_specific_rate = if_else(population == 0, 0, (deaths/ population*1000)))

# Now this is adding Age-standardized Rate per lsoa
# Calculate the age-standardized rate per LSOA
deaths_lsoa_eng_asdr  <- deaths_lsoa_eng %>%
  left_join(population_weights_England, by = c("age", "gender"))  %>%
  group_by(lsoa_code, lsoa_name, gender) %>%
  summarise(
    stdrate = sum(age_specific_rate * weight, na.rm = TRUE),
    population_lsoa = sum(population),
    deaths_lsoa = sum(deaths)) %>% 
  ungroup()
```

## MSOAs ASDRs by sex

```{r}

deaths_msoa <- merge(deaths_england, msoa, by.x = "lsoa_code", by.y = "LSOA11CD", all.x = TRUE)

deaths_msoa <- deaths_msoa %>% 
  select(-c(1,2,6,9,10)) %>% 
  rename("msoa_code" = "MSOA11CD",
         "msoa_name" = "MSOA11NM") %>% 
  group_by(msoa_code, msoa_name, gender, age) %>% 
  summarise(deaths = sum(deaths, na.rm = TRUE)) %>% 
  ungroup()

# Population estimates by age and sex by MSOA 

population_msoa <- merge(population_england, msoa, by.x = "lsoa_code", by.y = "LSOA11CD", all.x = TRUE)

population_msoa <- population_msoa %>% 
  select(-c(1,2,6,9,10)) %>% 
  rename("msoa_code" = "MSOA11CD",
         "msoa_name" = "MSOA11NM") %>% 
  group_by(msoa_code, msoa_name, gender, age) %>% 
  summarise(population = sum(population, na.rm = TRUE)) %>%
  ungroup()

deaths_msoa_eng <- merge(deaths_msoa, population_msoa, by = c("msoa_code", "msoa_name", "gender", "age"), all.x = TRUE)
  
# Age-specific (mortality) rates
deaths_msoa_eng  <- deaths_msoa_eng  %>%
  filter(!(population == 0 & deaths > 0)) %>% 
  mutate(age_specific_rate = if_else(population == 0, 0, (deaths/ population*1000)))
  
# Population weight for each age group
deaths_msoa_eng_asdr  <- deaths_msoa_eng  %>%
  left_join(population_weights_England) %>% #added, the reference population is england
#  filter(population != 0) %>% # should not filter
  group_by(msoa_code, msoa_name, gender) %>%
  summarise(
    stdrate = sum(age_specific_rate * weight, na.rm = TRUE),
    deaths_msoa = sum(deaths)) %>%
  ungroup()
```

## LADs ASDRs by sex

```{r}
deaths_lad <- merge(deaths_england, msoa, by.x = "lsoa_code", by.y = "LSOA11CD", all.x = TRUE)

deaths_lad <- deaths_lad %>% 
  select(-c(1,2,6,7,8)) %>% 
  rename("lad_code" = "LAD11CD",
         "lad_name" = "LAD11NM") %>% 
  group_by(lad_code, lad_name, gender, age) %>% 
  summarise(deaths = sum(deaths, na.rm = TRUE)) %>% 
  ungroup()

# Population estimates by age and sex by LAD 
population_lad <- merge(population_england, msoa, by.x = "lsoa_code", by.y = "LSOA11CD", all.x = TRUE)

population_lad <- population_lad %>% 
  select(-c(1,2,6,7,8)) %>% 
  rename("lad_code" = "LAD11CD",
         "lad_name" = "LAD11NM") %>% 
  group_by(lad_code, lad_name, gender, age) %>% 
  summarise(population = sum(population, na.rm = TRUE)) %>%
  ungroup()

deaths_lad_eng <- merge(deaths_lad, population_lad, by = c("lad_code", "lad_name", "gender", "age"), all.x = TRUE)

# Age-specific (mortality) crude rates
deaths_lad_eng  <- deaths_lad_eng  %>%
  filter(!(population == 0 & deaths > 0)) %>% 
  mutate(age_specific_rate = if_else(population == 0, 0, (deaths/ population*1000)))

# Age-standardized Rate
deaths_lad_eng_asdr  <- deaths_lad_eng  %>%
  left_join(population_weights_England) %>% 
#  filter(population != 0) %>%
  group_by(lad_code, lad_name, gender) %>%
  summarise(
    pop = sum(population),                       
    deaths = sum(deaths),
    stdrate = sum(age_specific_rate*weight)) %>%
  ungroup() 

```

## Calculate relative risks by lad and sex for all cause mortality

```{r}

england_lsoa_deaths <- deaths_lsoa_eng_asdr %>% 
  left_join(msoa, by = c("lsoa_code" = "LSOA11CD")) %>% 
  select(lsoa_code, lsoa_name, msoa_code = "MSOA11CD", lad_code = "LAD11CD",
         gender, population_lsoa, deaths_lsoa, stdrate) %>% 
  distinct() %>% 
  left_join(deaths_msoa_eng_asdr %>%  
    select(msoa_code, stdrate_msoa = stdrate, deaths_msoa, gender),
            by = c("msoa_code", "gender")) %>%
  left_join(deaths_lad_eng_asdr %>% 
    select(lad_code, stdrate_lad = stdrate, gender, deaths_lad = deaths),
            by = c("lad_code", "gender")) %>% 
  group_by(gender) %>% 
  mutate(
    # Adjust the logic to first check for deaths_lsoa and then deaths_msoa
    stdrate_selected = ifelse(
      deaths_lsoa <= 10 ,            # If LSOA deaths less than 10, use MSOA rate -
      ifelse(deaths_msoa <= 20,     # If MSOA deaths are less than 20, use LAD rate
             stdrate_lad,         
             stdrate_msoa),
      stdrate # Otherwise, use LSOA rate
    ),
    product = stdrate_selected * population_lsoa,  # Calculate product here
    stdrate_ave = sum(product, na.rm = TRUE) / sum(population_lsoa, na.rm = TRUE),  
    RR = stdrate_selected / stdrate_ave  # Calculate RR using the selected rate
  ) %>%
  ungroup()


## Manchester 

deaths_lad_eng_asdr_manchester <- deaths_lad_eng_asdr %>% 
   filter(
    str_starts(lad_name, "Bolton") |
      str_starts(lad_name, "Bury") |
      str_starts(lad_name, "Manchester") |
      str_starts(lad_name, "Oldham") |
      str_starts(lad_name, "Rochdale") |
      str_starts(lad_name, "Salford") |
      str_starts(lad_name, "Stockport") |
      str_starts(lad_name, "Tameside") |
      str_starts(lad_name, "Trafford") |
      str_starts(lad_name, "Wigan"))

```

## Adding Index of Multiple Deprivation (IMD)

Note: for the whole of England, clear gradient on overall age and sex
standardised rates and by gender.

```{r}
# Merge with index of deprivation 

deprivation <- deprivation %>%
  filter(`Indices of Deprivation` == "a. Index of Multiple Deprivation (IMD)") %>%
  filter(Measurement == "Decile") %>%
  mutate(deprivation="IMD") %>%
  rename(lsoa_code=FeatureCode) %>%
  select(lsoa_code, imd_decile=Value, deprivation)


```

## Overall ASR

From our calculated ASDRs for lsoas above we derive England ASDRs by IMD
and IMD and sex to check data follows an expected gradient.

```{r}

# Overall ASR 
england_deaths_socio <- england_lsoa_deaths %>%
  left_join(deprivation, by = "lsoa_code")

mortality_socio_all <- england_deaths_socio %>% 
  group_by(imd_decile) %>%
  summarise(
    # Only calculate the weighted mean if both rate_area_100000 and population are available
    ASR = sum(stdrate*population_lsoa, na.rm=TRUE)/sum(population_lsoa),
    .groups = "drop"
  )  %>%
  ungroup()

## Sex specific ASR

mortality_socio_gender <- england_deaths_socio %>%
  group_by(imd_decile, gender) %>%
  summarise(
    # Only calculate the weighted mean if both rate_area_100000 and population are available
    pop = sum(population_lsoa),
    deaths = sum(deaths_lsoa),
    asr = mean(stdrate),
    .groups = "drop"
  )  %>%
  ungroup() %>%
  arrange(gender)
  
```

## Area-specific age-standardized mortality rate

We assume that the excess mortality risk associated with living in a
particular area does not depend on age. We then estimate the
area-specific mortality rate for people of a particular age by
multiplying the mortality rate for England from life tables by the
area-specific relative risk by sex.

```{r}
# Join with mortality data

england_lifetable <- england_lifetable %>%
  mutate(sex=as.character(sex)) %>%
  mutate(sex=case_when(sex == "Male" ~ "Males", 
                       sex == "Female" ~ "Females")) %>%
  select(age, sex, rate1000)

# Merge with deaths data with relative risks for lsoa compared with england as a whole

england_lifetable_lsoa <- england_deaths_socio %>% 
  rename(sex = gender) %>% 
  cross_join(england_lifetable) %>% 
  filter(sex.x == sex.y) %>%
  mutate(rate1000=rate1000*RR) %>%
  select(lsoa_code, lsoa_name, sex = sex.x, age, rate1000, imd_decile, population_lsoa,RR)

# Filter for Greater Manchester Only:

manchester_lifetable_lsoa <- england_lifetable_lsoa %>% 
  filter(
    str_starts(lsoa_name, "Bolton") |
      str_starts(lsoa_name, "Bury") |
      str_starts(lsoa_name, "Manchester") |
      str_starts(lsoa_name, "Oldham") |
      str_starts(lsoa_name, "Rochdale") |
      str_starts(lsoa_name, "Salford") |
      str_starts(lsoa_name, "Stockport") |
      str_starts(lsoa_name, "Tameside") |
      str_starts(lsoa_name, "Trafford") |
      str_starts(lsoa_name, "Wigan")) %>%
  mutate(rate=rate1000/1000)

write.csv(manchester_lifetable_lsoa, here("manchester/health/processed/manchester_mortality_lsoa.csv"))


```

## Graphs for checking results

### Deaths rates for England by IMD

```{r}
# Graph death rates england

### Graph for England
# imd_decile is a factor

data_plot <- england_lifetable_lsoa %>%
  mutate(
    imd_decile = as.factor(imd_decile),  # Ensure imd_decile is a factor
    rate1000 = log(ifelse(rate1000 == 0, 0.00000000001, rate1000)))  # Replace zeros in rate1000
 

p_england <- ggplot(data_plot, 
                    aes(x = age, y = rate1000,
                        col = imd_decile,  # Color by IMD decile
                        group = lsoa_code)) +  # Each LSOA has its own line
  geom_line(lwd = 0.7, alpha = 0.5) +  # Reduce opacity to manage overplotting
  facet_wrap(~ sex) +  # Compare IMD deciles within each sex
  ylab("Mortality rate (per 1000)") + 
  xlab("Age (years)") +  
  scale_y_continuous(breaks=c(0.0002, 0.0005, 0.001, 0.005, 0.01, 0.05, 0.1, 0.2)*1000) +
  scale_color_viridis_d(option = "C", name = "IMD Decile") +  # Use discrete color scale
  theme_minimal(base_size = 14) +  
  theme(
    strip.text = element_text(face = "bold"),
    legend.position = "bottom"  # Move legend for readability
  ) +
  ggtitle("Death rates England")  # Add title

# Print the plot
print(p_england)

interactive_p_england <- ggplotly(p_england)
```

### Deaths rates for Greater Manchester by IMD

```{r}
# Graph death rates Manchester

data_plot <- manchester_lifetable_lsoa %>%
  mutate(
    imd_decile = as.factor(imd_decile),  # Ensure imd_decile is a factor
    rate1000 = log(ifelse(rate1000 == 0, 0.00000000001, rate1000))  # Replace zeros in rate1000
  )

p_manchester <- ggplot(data_plot, 
                    aes(x = age, y = rate1000,
                        col = imd_decile,  # Color by IMD decile
                        group = lsoa_code)) +  # Each LSOA has its own line
  geom_line(lwd = 0.7, alpha = 0.5) +  # Reduce opacity to manage overplotting
  facet_wrap(~ sex) +  # Compare IMD deciles within each sex
  ylab("Mortality rate (per 1000)") + 
  xlab("Age (years)") +  
    scale_y_continuous(breaks=c(0.0002, 0.0005, 0.001, 0.005, 0.01, 0.05, 0.1, 0.2)*1000) +
  scale_color_viridis_d(option = "C", name = "IMD Decile") +  # Use discrete color scale
  theme_minimal(base_size = 14) +  
  theme(
    strip.text = element_text(face = "bold"),
    legend.position = "bottom"  # Move legend for readability
  )  +
  ggtitle("Death rates Greater Manchester")  # Add title

# Print the plot
print(p_manchester)

# RR plots for Manchester

manchester_deaths_socio <- england_deaths_socio %>% 
  filter(
    str_starts(lsoa_name, "Bolton") |
      str_starts(lsoa_name, "Bury") |
      str_starts(lsoa_name, "Manchester") |
      str_starts(lsoa_name, "Oldham") |
      str_starts(lsoa_name, "Rochdale") |
      str_starts(lsoa_name, "Salford") |
      str_starts(lsoa_name, "Stockport") |
      str_starts(lsoa_name, "Tameside") |
      str_starts(lsoa_name, "Trafford") |
      str_starts(lsoa_name, "Wigan"))

rr_plot <- ggplot(manchester_deaths_socio, aes(x = imd_decile, y = RR, color = as.factor(imd_decile))) +
  geom_point(alpha = 0.7, size = 3) +  # Add points with transparency and size
  geom_smooth(method = "lm", se = FALSE, aes(group = 1), color = "blue") +  # Add a linear regression line
  scale_x_continuous(breaks = 1:10) +  # Set x-axis breaks for IMD deciles
  labs(
    title = "Relative Mortality Risk for LSOA by Deprivation Decile, Manchester (2016-2019)",
    x = "Deprivation Decile (1 - Most Deprived, 10 - Least Deprived)",
    y = "Relative Mortality Risk (RR)",
    color = "Deprivation Decile"
  ) +
  theme_minimal() +
  theme(
    panel.grid.minor = element_blank(),
    legend.position = "bottom"
  ) +
  theme(legend.title = element_text(face = "bold"), legend.text = element_text(size = 10))


rr_plot

```

### Comparison with publicly available estimates by LADs and sex

Comparison of age standardised rates with ONS data by LAD and our
calculations but using weight from the European standard population. We
use European standard population to compare because ASDR per LAD from
ONS use this weights in their calculations.

stdr_rate ons is publised, stdr_rate_eng is calculated by us using
England population weights and stdr_rate_eu is our estimates using
European standard population weights. Our estimates using European
standard rates compare with published ONS rates.

```{r}

### European Standard Population 2013

european_pop_2 <- european_pop %>%
  mutate(Sex = ifelse(Sex == "Male", "Males", "Females")) %>%
  rename(
    "age" = "AgeGroup",
   "gender" = "Sex",
    "population" = "EuropeanStandardPopulation"
  ) %>%
  mutate(age = case_when(
    age == "90plus years" | age == "85-89 years" ~ "over 85",
    TRUE ~ str_replace(age, "(\\d+)-(\\d+)", "\\1 to \\2")
  )) %>%
  mutate(age = str_replace_all(age, "\\b(\\d)\\b", "0\\1")) %>%
  mutate(age = str_replace(age, " years", "")) %>%  # Remove 'years'
  mutate(age = ifelse(age == "00 to 04", "01 to 04", age)) %>%  # Rename '00 to 04'
  group_by(age, gender) %>%
  summarise(population = sum(population), .groups = 'drop')


# Calculate age-specific population and join with gender totals
population_weights_europe <- european_pop_2 %>%
  select(gender, age, population) %>%
  group_by(gender, age) %>%
  summarise(age_population = sum(population)) %>%  # Total population by gender and age
  ungroup() %>%
  mutate(weight=age_population/100000)

## Calculate all ASDRs by areas with European population

# lsoa
deaths_lsoa_eng_eu  <- deaths_lsoa_eng %>%
  left_join(population_weights_europe, by = c("age", "gender")) %>%
  group_by(lsoa_code, lsoa_name, gender) %>%
  summarise(
    stdrate = sum(age_specific_rate * weight, na.rm = TRUE),
    population_lsoa = sum(population),
    deaths_lsoa = sum(deaths))

#msoa
deaths_msoa_eng_eu  <- deaths_msoa_eng  %>%
  left_join(population_weights_europe, by = c("age", "gender")) %>%
  group_by(msoa_code, msoa_name, gender) %>%
  summarise(
    stdrate = sum(age_specific_rate * weight, na.rm = TRUE),
    deaths_msoa = sum(deaths)) %>%
  ungroup()

#lad
deaths_lad_eng_eu  <- deaths_lad_eng  %>%
  left_join(population_weights_europe, by = c("age", "gender")) %>%
  group_by(lad_code, lad_name, gender) %>%
  summarise(
    stdrate = sum(age_specific_rate*weight,  na.rm = TRUE)) %>%
  ungroup()

#Filter for Manchester only
deaths_lad_eu_asdr_manchester <- deaths_lad_eng_eu %>% 
  filter(
    str_starts(lad_name, "Bolton") |
      str_starts(lad_name, "Bury") |
      str_starts(lad_name, "Manchester") |
      str_starts(lad_name, "Oldham") |
      str_starts(lad_name, "Rochdale") |
      str_starts(lad_name, "Salford") |
      str_starts(lad_name, "Stockport") |
      str_starts(lad_name, "Tameside") |
      str_starts(lad_name, "Trafford") |
      str_starts(lad_name, "Wigan"))

# Creating Comparison Table between ONS and Our Estimates using English Population and European Standard Population

comparison_table <- nomis_lad %>% 
  left_join(deaths_lad_eng_asdr_manchester %>% 
              select(lad_name, gender, stdrate_eng = stdrate), by = c("gender", "lad_name")) %>% 
  left_join(deaths_lad_eu_asdr_manchester %>% 
              select(lad_name, gender, stdrate_eu = stdrate), by = c("gender", "lad_name"))

print(comparison_table)

```

## Additional comparisons (Marina to add some explanation)

```{r}
# Additional 

england_lsoa_deaths_eu <- deaths_lsoa_eng_eu |>
  left_join(msoa, join_by(lsoa_code == LSOA11CD)) |>
  select(lsoa_code, lsoa_name, msoa_code = "MSOA11CD", lad_code = "LAD11CD",gender,population_lsoa, deaths_lsoa, stdrate) |>
  distinct() |>
  left_join(deaths_msoa_eng_eu |> select(msoa_code, stdrate_msoa = stdrate, deaths_msoa,gender), by= c("msoa_code","gender")) |>
  left_join(deaths_lad_eng_eu |> select(lad_code, stdrate_lad = stdrate,gender), by=c("lad_code","gender")) %>%
  group_by (gender) %>%
  # Use MSOA rate if LSOA std rate is missing or has fewer than 10 deaths, and use LAD if msoa deaths are fewer than 20
  mutate(stdrate_ave = with(.data, sum(stdrate*population_lsoa,na.rm = TRUE)/sum(population_lsoa)),
         stdrate = ifelse(
           is.na(stdrate) | deaths_lsoa < 10,   # if NA or fewer than 10 deaths at the lsoa level, use msoa
           ifelse(
             deaths_msoa > 20,             # if fewer than 20 deaths at the msoa level, use lad
             stdrate_msoa,
             stdrate_lad),
           stdrate)) |>                    # if not NA and more than or equal to 10, use lsoa
  mutate(RR = stdrate / stdrate_ave)

# Adding level of deprivation

england_deaths_socio_eu <- england_lsoa_deaths_eu %>%
  left_join(deprivation, by = "lsoa_code")

# For All
mortality_socio_all_eu <- england_deaths_socio_eu %>%
  group_by(imd_decile) %>%
  summarise(
    # Only calculate the weighted mean if both rate_area_100000 and population are available
    ASR = sum(stdrate*population_lsoa, na.rm=TRUE)/sum(population_lsoa),
    .groups = "drop"
  )  %>%
  ungroup()

### Sex specific ASR

mortality_socio_gender_eu <- england_deaths_socio_eu %>%
  group_by(imd_decile, gender) %>%
  summarise(
    # Only calculate the weighted mean if both rate_area_100000 and population are available
    ASR = sum(stdrate*population_lsoa, na.rm=TRUE)/sum(population_lsoa),
    .groups = "drop"
  )  %>%
  ungroup()

# lad of Greater Manchester Only

deaths_lad_man_eu <- deaths_lad_eng_eu %>%
  filter(
    str_starts(lad_name, "Bolton") |
      str_starts(lad_name, "Bury") |
      str_starts(lad_name, "Manchester") |
      str_starts(lad_name, "Oldham") |
      str_starts(lad_name, "Rochdale") |
      str_starts(lad_name, "Salford") |
      str_starts(lad_name, "Stockport") |
      str_starts(lad_name, "Tameside") |
      str_starts(lad_name, "Trafford") |
      str_starts(lad_name, "Wigan"))

print(deaths_lad_man_eu)

deaths_lad_man_eng <- deaths_lad_eng_asdr %>%
  filter(
    str_starts(lad_name, "Bolton") |
      str_starts(lad_name, "Bury") |
      str_starts(lad_name, "Manchester") |
      str_starts(lad_name, "Oldham") |
      str_starts(lad_name, "Rochdale") |
      str_starts(lad_name, "Salford") |
      str_starts(lad_name, "Stockport") |
      str_starts(lad_name, "Tameside") |
      str_starts(lad_name, "Trafford") |
      str_starts(lad_name, "Wigan"))

print(deaths_lad_man_eng)
```

# Disease Incidence

For a list of diseases related to the modeled health risk factors
including physical activity, air pollution (PM25 and NO2), noise and
greenspace, we need incidence rates by age, sex and also by LAD
(available from GBD). We also need prevalence to assign initial health
state in the model. The main data transformations were to:

1\) interpolate from 5 year age groups to 1.

2\) Adjust colon and rectum cancers to only reflect on colon cancer
proportion.

3\) Adjust Tracheal, bronchus, and lung cancer to only reflect on lung
cancer.

4\) Replace rates for LADs with small numbers of incidence and
prevalence with higher level data for Greater Manchester.

For colon cancer, we adjusted incidence and prevalence based on
estimates from the American Cancer Society in the absence of estimates
for England. 2/3 of colon and rectum cancer is attributed to colon
cancer
(<https://www.cancer.org/cancer/types/colon-rectal-cancer/about/key-statistics.html>).

For lung cancer, we compare total Tracheal, bronchus, and lung cancer
from GBD data with England statistics
(<https://digital.nhs.uk/data-and-information/publications/statistical/cancer-registration-statistics/england-2021---summary-counts-only/cancer-incidence>).
GBD estimates 38,829 incident cases of Tracheal, bronchus, and lung
cancer and estimates from England indicate 20,742. We assume that 54% of
Tracheal, bronchus, and lung cancer is lung cancer for both incidence
and prevalence.

## Data Sources

```{r include = FALSE}
# GBD data for Manchester LADs
gbd <- bind_rows(
  read.csv(here("manchester/health/original/GBD/IHME-GBD_2021_data-bfdf8007-1.csv")), 
  read.csv(here("manchester/health/original/gbd/IHME-GBD_2021_DATA-125d4b23-1.csv")), 
  read.csv(here("manchester/health/original/gbd/IHME-GBD_2021_DATA-1316cd33-1.csv")),
  read.csv(here("manchester/health/original/gbd/IHME-GBD_2021_DATA-cffadb37-1.csv")),
  read.csv(here("manchester/health/original/gbd/IHME-GBD_2021_DATA-131cf659-1.csv")),
  read.csv(here("manchester/health/original/gbd/IHME-GBD_2021_DATA-4fbe0549-1.csv")), 
  read.csv(here("manchester/health/original/gbd/parkinsons1.csv")),
  read.csv(here("manchester/health/original/gbd/parkinsons3.csv")))

gbdp <- gbd_process(gbd)

# GBD data for Northwest (just diseases with low numbers for LADs in Grater Manchester)

gbd_england <-  read.csv(here("manchester/health/original/GBD/england_nortwest.csv"))


gbdp_nw <- gbd_england %>% filter(location == "North West England") %>%
  gbd_process(.)

gbdp_england <- gbd_england %>% filter(location == "England") %>%
  gbd_process(.)
```

## Replace small diseases

For health-state transitions  ≥20 cases per 100,000 as a baseline
threshold for age specific rates
<https://www.cdc.gov/nchs/data/series/sr_02/sr02-200.pdf>.

Information on the average age onset of diseases is also needed to set a
lower threshold below which the min cases per 100,000 does not apply.

| Disease                                          | Average onset age                                                                                             | Source                                                                                                                                                                       |
|--------------------------------------------------|---------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Major Depressive Disorder**                    | Often emerges during adolescence or early adulthood, typically between ages 18 and 25                         | [NHS & Mental Health Foundation UK](http%20s://www.me%20ntalhealth%20.org.uk/); [National Institute for Health and Care Excellence (NIC E)](https:%20//www.nice%20.org.uk/). |
| **Prostate Cancer**                              | Commonly diagnosed in men aged 65 and older.​                                                                  | [Cancer Research UK](https%20://www.can%20cerresearc%20huk.org/).                                                                                                            |
| **Colon and Rectum Cancer**                      | The majority of cases are diagnosed in individuals over 50.​                                                   | [NHS Bowel Cancer Screening Progra mme](https%20://www.nhs%20.uk/condit%20ions/bowel%20-cancer-sc%20reening/).                                                               |
| **Nasopharynx Cancer**                           | More prevalent in individuals between 30 and 50 years old.​                                                    | \[British Journal of Cancer\] (https://w ww.nature. com/bjc/).                                                                                                               |
| **Kidney Cancer**                                | Often diagnosed between ages 55 and 75.                                                                       | [Cancer Research UK](https%20://www.can%20cerresearc%20huk.org/).                                                                                                            |
| **Bladder Cancer**                               | Typically found in individuals over 55.​                                                                       | [NHS Cancer Statistics](https://%20www.nhs.uk%20/condition%20s/cancer/)                                                                                                      |
| **Chronic Myeloid Leukemia (CML)**               | The median age at diagnosis is approximately 65 years.​                                                        | [Leukaemia Care UK](http%20s://www.le%20ukaemiacar%20e.org.uk/)                                                                                                              |
| **Multiple Myeloma**                             | The median age at diagnosis is around 67 years.                                                               | [Myeloma UK](https://%20www.myelom%20a.org.uk/)                                                                                                                              |
| **Cardiovascular Diseases**                      | Risk increases with age, particularly after 45 for men and 55 for women.                                      | [British Heart Foundat ion](https%20://www.bhf%20.org.uk/).                                                                                                                  |
| **Tracheal, Bronchus, and Lung Cancer**          | Most commonly diagnosed in individuals over 65.​                                                               | [British Lung Foundat ion](https%20://www.blf%20.org.uk/).                                                                                                                   |
| **Stomach Cancer**                               | More frequently diagnosed in people over 65.                                                                  | [Cancer Research UK](https%20://www.can%20cerresearc%20huk.org/).                                                                                                            |
| **Uterine Cancer**                               | Most cases occur in women over 50.                                                                            | \[NHS England\] (https://w ww.england .nhs.uk/).                                                                                                                             |
| **Stroke**                                       | Risk increases with age, with most strokes occurring in individuals over 65.​                                  | [Stroke A ssociation UK](https://%20www.stroke%20.org.uk/).                                                                                                                  |
| **Malignant Skin Melanoma**                      | Average age at diagnosis is around 63 years, though it is also common in younger adults.​                      | [UK D ermatology Soci ety](https%20://www.bad%20.org.uk/).                                                                                                                   |
| **Lip and Oral Cavity Cancer**                   | Typically diagnosed in individuals over 60.​                                                                   | [British Dental Assoc iation](ht%20tps://www.%20bda.org/).                                                                                                                   |
| **Other Pharynx Cancer**                         | Often diagnosed in people between 50 and 60 years old.​                                                        | [Cancer Research UK](https%20://www.can%20cerresearc%20huk.org/).                                                                                                            |
| **Larynx Cancer**                                | Most common in individuals aged 55 to 74.​                                                                     | \[NHS England\] (https://w ww.england .nhs.uk/).                                                                                                                             |
| **Esophageal Cancer**                            | Typically diagnosed between ages 55 and 85.​                                                                   | [Cancer Research UK](https%20://www.can%20cerresearc%20huk.org/).                                                                                                            |
| **Ischemic Stroke**                              | Similar to general stroke statistics, with most cases occurring in individuals over 65.​                       |                                                                                                                                                                              |
| **Breast Cancer**                                | The median age at diagnosis is approximately 62 years                                                         | [Breast Cancer Now UK](https://br%20eastcancer%20now.org/).                                                                                                                  |
| **Liver Cancer**                                 | Most commonly diagnosed in individuals over 60.​                                                               | [Cancer Research UK](https%20://www.can%20cerresearc%20huk.org/).                                                                                                            |
| **Chronic Obstructive Pulmonary Disease (COPD)** | Typically diagnosed in individuals aged 40 and older.​                                                         | [British Lung Foundat ion](https%20://www.blf%20.org.uk/).                                                                                                                   |
| **Diabetes Mellitus Type 2**                     | Commonly diagnosed in adults over 45, though increasing rates are observed in younger populations.            | \[Diabetes UK\] (https://w ww.diabete s.org.uk/)                                                                                                                             |
| **Ischemic Heart Disease**                       | Risk increases significantly after 45 for men and 55 for women.​                                               | [British Heart Foundat ion](https%20://www.bhf%20.org.uk/).                                                                                                                  |
| **Alzheimer's Disease and Other Dementias**      | Most commonly diagnosed in individuals over 65, with risk doubling approximately every five years thereafter.​ | [A lzheimer's Society UK](ht%20tps://www.%20alzheimers%20.org.uk/).                                                                                                          |
| **Parkinson's Disease**                          | Average age at diagnosis is around 60 years, though early-onset forms can occur before 50.                    | [P arkinson’s UK](ht%20tps://www.%20parkinsons%20.org.uk/).                                                                                                                  |

```{r}

## Read onset disease table (might not use)

disease_onset <- read_csv(here("health/disease_onset.csv")) %>%
  select(cause, age_onset = age)

## Check for small values

gbd_lads_small <- gbdp %>%
  filter(!measure == "Deaths") %>%
  left_join(disease_onset, by = "cause") %>%  # Explicitly join by cause
  mutate(small_lads = case_when(val <= 20 ~ "yes",    
    TRUE ~ "no"                             
  ))

## List diseases with small numbers for at least one lad

small_diseases_lads <- gbd_lads_small %>% filter(small_lads == "yes") %>%
  distinct(cause) %>%
  pull(cause)

## Aggreagate for Greater Manchester

gbd_GM_small <- gbdp %>%
  filter(!measure == "Deaths") %>%
  group_by(measure, sex, agegroup, from_age, to_age, cause, metric, year, val, agediff, val1yr) %>%
  summarise(val_GM = sum(val), 
            val1yr_GM = sum(val1yr)) %>%
  ungroup() %>%
  left_join(disease_onset, by = "cause") %>%  # Explicitly join by cause
  mutate(small_gm = case_when(val_GM <= 20 ~ "yes",    
    TRUE ~ "no"                             
  ), 
  rate_1_GM=val_GM/100000)

gbd_nw_small <- gbdp_nw %>% 
  left_join(disease_onset, by = "cause") %>%  # Explicitly join by cause
  mutate(small_nw = case_when(val <= 20 ~ "yes",    
    TRUE ~ "no"                             
  )) %>% rename(location_region = location, 
                val_nw = val, 
                val1yr_nw = val1yr, 
                rate_1_nw = rate_1)


gbd_eng_small <- gbdp_england %>% 
  left_join(disease_onset, by = "cause") %>%  # Explicitly join by cause
  mutate(small_eng = case_when(val <= 20 ~ "yes",    
    TRUE ~ "no"                             
  )) %>% rename(location_country = location, 
                val_eng = val, 
                val1yr_eng = val1yr, 
                rate_1_eng = rate_1)


## Replace rates in LADs data if small with Greater Manchester, NorthWest, England


gbd_combined <- left_join(gbd_lads_small, gbd_GM_small) %>% 
                left_join(gbd_nw_small) %>%
                left_join(gbd_eng_small) %>%
  mutate(
    # Replace 'val' based on conditions
    val = case_when(
      small_lads == "yes" & small_gm == "yes" ~ val_nw,
      small_lads == "yes" ~ val_GM,
      small_nw == "yes" ~ val_eng,
      TRUE ~ val  # Keep original value if no condition is met
    ),
    # Replace 'rate_1' based on conditions
    rate_1 = case_when(
      small_lads == "yes" & small_gm == "yes" ~ rate_1_nw,
      small_lads == "yes" ~ rate_1_GM,
      small_nw == "yes" ~ rate_1_eng,
      TRUE ~ rate_1  # Keep original value if no condition is met
    ),
    # Replace 'val1yr' based on conditions
    val1yr = case_when(
      small_lads == "yes" & small_gm == "yes" ~ val1yr_nw,
      small_lads == "yes" ~ val1yr_GM,
      small_nw == "yes" ~ val1yr_eng,
      TRUE ~ val1yr  # Keep original value if no condition is met
    )
  ) %>% select(measure, sex, agediff, agegroup, from_age, to_age, cause, year, val1yr,rate_1, location)

gbdp_combined <- gbd_combined

  
```

## Interpolation

```{r}
# Now stretch the data out using an index, to create a data frame with 1 row per year of age and create a variable for year of age. 
# The age group rate repeats within single years of age in the group. 
index <- rep(1:nrow(gbdp), gbdp$agediff)
gbdpyrd5 <- gbdp[index,] %>%
  mutate(ageyr = from_age + sequence(gbdp$agediff) - 1)
gbdpyrd5 <- gbdpyrd5 %>%  
  select(measure, ageyr, sex, agegroup, from_age, to_age, cause, year, val1yr,rate_1, location) 

# Apply the disaggregation function

# Group data for dissaggregation 

gbdp_grp <- gbdp %>%
  group_by(measure, year, sex, cause, location) %>%
  arrange(measure, year, sex, cause, from_age) 


# Apply function (select a function from 'functions/interpolation.R'). Smooth_spline does a good job.
gbdpyr_interp <- group_modify(gbdp_grp, disagg_smooth_spline) %>%
  ungroup()

# Filter the rows where ageyr is 95
age_95_data <- gbdpyr_interp %>% filter(ageyr == 95)

# Create new rows for ageyr 96 to 100, repeating the values for val_interpolated
new_rows <- age_95_data %>%
  mutate(ageyr = list(96:100)) %>%
  unnest(ageyr) 

# Combine the original data frame with the new rows
gbdpyr_interp <- bind_rows(gbdpyr_interp, new_rows)

rm(new_rows, age_95_data)

# Merge with lad zones data
 gbdpyr_interp <- msoa %>%
   select(ladcd = LAD11CD, location = LAD11NM) %>% 
   distinct() %>%
   filter(str_starts(location, "Bolton") |
       str_starts(location, "Bury") |
       str_starts(location, "Manchester") |
       str_starts(location, "Oldham") |
       str_starts(location, "Rochdale") |
       str_starts(location, "Salford") |
       str_starts(location, "Stockport") |
       str_starts(location, "Tameside") |
       str_starts(location, "Trafford") |
       str_starts(location, "Wigan")) %>% 
   left_join(gbdpyr_interp, by = "location")

#Note: this is a very big file, so changed to RDS
write_rds(gbdpyr_interp, here("manchester/health/processed/manchester_diseases_lad.RDS"))

#Join with original data where rates are the same within groups to validate interpolated data
gbdpyr_interp <- gbdpyr_interp %>%
  left_join(gbdpyrd5, by = c("measure", "year", "ageyr", "sex", "cause", "location"))

### Below takes a long time, unless somethings changes, once graphs generated, no need to run again.
# Plot data to check interpolated values against 5-year age group values (original data)
## Four interpolation function could be use, the best fit should be used. For now, best fit to the data assessed visually.

# # # Melt the data to long format for ggplot
plot_data <- gbdpyr_interp %>%
  select(measure, cause, sex, ageyr, rate_1, val_interpolated, location) %>%
  pivot_longer(cols = c(rate_1, val_interpolated), names_to = "type", values_to = "value")

# Define output directory
output_dir <- "images/manchester/inc_gbd_age_sex/"
if (!dir.exists(output_dir)) {
  dir.create(output_dir, recursive = TRUE)
}

# Get unique combinations of measure, cause, sex, and location
combinations <- plot_data %>%
  distinct(measure, cause, sex, location)

# Generate and save plots for each combination
for (i in 1:nrow(combinations)) {
  subset_df <- plot_data %>%
    filter(measure == combinations$measure[i],
           cause == combinations$cause[i],
           sex == combinations$sex[i],
           location == combinations$location[i])
  p <- ggplot(subset_df, aes(x = ageyr, y = value, color = type)) +
    geom_line() +
    labs(title = paste("Measure:", combinations$measure[i],
                       "Cause:", combinations$cause[i],
                       "Sex:", combinations$sex[i],
                       "Location:", combinations$location[i]),
         x = "Age (years)",
         y = "Value") +
    theme_minimal(base_family = "Arial") +
    theme(panel.background = element_rect(fill = "white", color = "white"),
          plot.background = element_rect(fill = "white", color = "white"))
# # Save the plot
  ggsave(filename = paste0(output_dir, "plot_", i, ".png"), plot = p, width = 8, height = 6)
}
```

# Combining All-cause Mortality and Disease Incidence Data

```{r}

### NAMES NEED TO MATCH CODE FOR HEALTH MODEL

diseases <- readRDS(here("manchester/health/processed/manchester_diseases_lad.RDS"))
allcause <- read.csv(here("manchester/health/processed/manchester_mortality_lsoa_070325.csv"))
lsoa_11to21 <- read.csv(here("manchester/health/original/ons/lsoa_2011_to_lsoa_2021.csv"))

# Process data 

allcause<- allcause %>%
  mutate(cause = "all_cause_mortality",
         measure = "deaths") %>%
  mutate(sex=case_when(sex == "Males" ~ "male",
                                  sex=="Females" ~ "female"),
         location_code = lsoa_code, 
         age=as.numeric(age)) %>% 
  dplyr::select(age, sex, location_code, cause, rate, measure) %>%
  mutate(location_type = "lsoa")

diseases <- diseases %>% 
  mutate(measure = tolower(measure),
         cause = tolower(cause),
         socio = NA) %>% 
  rename(age = ageyr,
         rate = val_interpolated) %>%
  mutate(sex=case_when(sex == "Male" ~ "male",
                                  sex=="Female" ~ "female")) %>%
  dplyr::select(age, sex, location_code = ladcd,cause, rate, measure) %>%
  mutate(location_type = "lad")

incidence <- diseases %>% filter(measure == "incidence") 
prevalence <- diseases %>% filter(measure == "prevalence") %>%
  mutate(sex=case_when(sex == "male" ~ 1, 
                       sex == "female" ~ 2))

health_transitions_manchester <- bind_rows(allcause, incidence)

# Save prevalence and incidence (includes deaths from all causes) separetly

write.csv(prevalence, here("manchester/health/processed/health_transitions_manchester_prevalence.csv"))

write.csv(health_transitions_manchester, here("manchester/health/processed/health_transitions_manchester_raw.csv"))
```
