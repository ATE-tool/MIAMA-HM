---
title: "Health Data Manchester"
author: "Marina Berdikhaniva, Belen Zapata-Diomedi"
email: "mbzd2@cam.ac.uk, mb2592@cam.ac.uk"
date: today
format: 
  html:
    code-fold: true
    embed-resources: true
    df-print: paged
execute: 
    message: false
    warning: false
toc: true
number-sections: true
editor_options:
  mode: visual
  markdown:
    wrap: 72
---s
---

# Introduction

This document explains and produces estimates for the inputs for the
health model for JIBE Manchester. The model initially has four stages
where individuals are in a healthy state, might become diseased of one
or more diseases, and die from any causes (regardless health status).
For this first iteration of the model we need estimates of incidence,
prevalence (for assignment of initial state) and all cause mortality. A
second iteration will add a differential all cause mortality risk for
individuals who have one or more diseases. Last, we might want to
include trends in mortality, incidence of diseases and prevalence of
diseases.

```{r setup, include=FALSE}

rm(list = ls())

library(tidyverse)  # Includes dplyr, tidyr, readr, ggplot2, purrr, etc.
library(readxl)   # Read/write Excel files
library(knitr)      # Report generation
library(gt)         # Pretty tables
library(here)       # File path management
# Set root directory one level up from current directory
knitr::opts_knit$set(root.dir = dirname(getwd()))

# Functions
source("docs/functions/interpolation.R")

# Avoid scientific notation
options("scipen"=100, "digits"=4)

knitr::opts_chunk$set(
  echo = FALSE,          # Hide code by default
  message = FALSE,       # Suppress messages
  warning = FALSE)        # Suppress warnings
```

# All-Cause Mortality

## Data Sources

```{r data-prep}

# Mortality by LSOA by age and sex (Year: 2018) 
# [Source]: https://www.ons.gov.uk/peoplepopulationandcommunity/birthsdeathsandmarriages/deaths/adhocs/1028deathregistrationsbysexfiveyearagegroupandlowerlayersuperoutputareaslsoa2011censusboundariesenglandandwales2001to2021

# Import data from ONS
deaths_males <- read_xlsx(
  here("manchester/health/original/ons", "DeathsbyLSOAmidyear11to21.xlsx"),
  sheet = "2",
  skip = 2
)
deaths_females <- read_xlsx(
  here("manchester/health/original/ons", "DeathsbyLSOAmidyear11to21.xlsx"),
  sheet = "3",
  skip = 2
)


# Filter for 2018
deaths_males <- deaths_males %>% 
  filter(`Mid-year` %in% c(2018))
deaths_females <- deaths_females %>% 
  filter(`Mid-year` %in% c(2018))

# Merge Males and Females data
deaths <- merge(deaths_males, deaths_females, by = c("LSOA code"))

rm(deaths_males, deaths_females)

# Reshape the data
deaths <- deaths %>%
  pivot_longer(cols = c(starts_with("Males"), starts_with("Females")),  
               names_to = c("gender", "age"),                          
               names_pattern = "(Males|Females) (.+)",                 
               values_to = "deaths")

# Final data clean up 
deaths_england <- deaths %>% 
  filter(!str_starts(`LSOA code`, "W")) %>% # Remove Wales
  select(
    lsoa_code = `LSOA code`,                     
    lsoa_name = `LSOA name.x`,                   
    gender,                
    age,
    deaths) %>% 
  mutate(age = case_when(
    age %in% c("under 1", "01 to 04") ~ "00 to 04", 
    TRUE ~ age
  )) %>%
  group_by(lsoa_code, lsoa_name, age, gender) %>%
  summarize(deaths = sum(deaths),.groups = "drop") %>%
  ungroup()

rm(deaths)
 
# Population Data by LSOA by age and sex (Year: 2018)
#[Source]: https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/lowersuperoutputareamidyearpopulationestimates

pop_males <- read_xlsx(
  here("manchester/health/original/ons", "SAPE21DT1a-mid-2018-on-2019-LA-lsoa-syoa-estimates-formatted.xlsx"),
  sheet = "Mid-2018 Males", 
  skip = 3
)

pop_females <- read_xlsx(
  here("manchester/health/original/ons", "SAPE21DT1a-mid-2018-on-2019-LA-lsoa-syoa-estimates-formatted.xlsx"),
  sheet = "Mid-2018 Females", 
  skip = 3
)

# Males

# Remove Wales
pop_males <- pop_males %>% 
  filter(LSOA != '', !str_starts(`Area Codes`,"W")) %>% 
  rename("lsoa_name" = "LSOA",
         "lsoa_code" = "Area Codes") %>% 
  select(-c(2, 4))

# Create age groups
pop_males <- pop_males %>% 
  mutate(
    `00 to 04` = rowSums(select(pop_males, `0`,`1`, `2`, `3`, `4`), na.rm = TRUE),
    `05 to 09` = rowSums(select(pop_males, `5`, `6`, `7`, `8`, `9`), na.rm = TRUE),
    `10 to 14` = rowSums(select(pop_males, `10`, `11`, `12`, `13`, `14`), na.rm = TRUE),
    `15 to 19` = rowSums(select(pop_males, `15`, `16`, `17`, `18`, `19`), na.rm = TRUE),
    `20 to 24` = rowSums(select(pop_males, `20`, `21`, `22`, `23`, `24`), na.rm = TRUE),
    `25 to 29` = rowSums(select(pop_males, `25`, `26`, `27`, `28`, `29`), na.rm = TRUE),
    `30 to 34` = rowSums(select(pop_males, `30`, `31`, `32`, `33`, `34`), na.rm = TRUE),
    `35 to 39` = rowSums(select(pop_males, `35`, `36`, `37`, `38`, `39`), na.rm = TRUE),
    `40 to 44` = rowSums(select(pop_males, `40`, `41`, `42`, `43`, `44`), na.rm = TRUE),
    `45 to 49` = rowSums(select(pop_males, `45`, `46`, `47`, `48`, `49`), na.rm = TRUE),
    `50 to 54` = rowSums(select(pop_males, `50`, `51`, `52`, `53`, `54`), na.rm = TRUE),
    `55 to 59` = rowSums(select(pop_males, `55`, `56`, `57`, `58`, `59`), na.rm = TRUE),
    `60 to 64` = rowSums(select(pop_males, `60`, `61`, `62`, `63`, `64`), na.rm = TRUE),
    `65 to 69` = rowSums(select(pop_males, `65`, `66`, `67`, `68`, `69`), na.rm = TRUE),
    `70 to 74` = rowSums(select(pop_males, `70`, `71`, `72`, `73`, `74`), na.rm = TRUE),
    `75 to 79` = rowSums(select(pop_males, `75`, `76`, `77`, `78`, `79`), na.rm = TRUE),
    `80 to 84` = rowSums(select(pop_males, `80`, `81`, `82`, `83`, `84`), na.rm = TRUE),
    `over 85` = rowSums(select(pop_males, `85`:`89`, `90+`), na.rm = TRUE)
  ) %>%
  select(`lsoa_code`, lsoa_name, `00 to 04`, `05 to 09`, `10 to 14`, `15 to 19`, `20 to 24`, `25 to 29`, `30 to 34`, 
         `35 to 39`, `40 to 44`, `45 to 49`, `50 to 54`, `55 to 59`, `60 to 64`, `65 to 69`, 
         `70 to 74`, `75 to 79`, `80 to 84`, `over 85`)

# Reshape the data
pop_males <- pop_males %>%
  pivot_longer(
    cols = -c(lsoa_name, lsoa_code),
    names_to = "age",        
    values_to = "population") %>% 
  mutate(gender = "Males")

# Females 

# Remove Wales
pop_females <- pop_females %>% 
  filter(LSOA != '', !str_starts(`Area Codes`,"W")) %>% 
  rename("lsoa_name" = "LSOA",
         "lsoa_code" = "Area Codes") %>% 
  select(-c(2, 4))

pop_females <- pop_females %>% 
  mutate(
    `00 to 04` = rowSums(select(pop_females, `0`,`1`, `2`, `3`, `4`), na.rm = TRUE),
    `05 to 09` = rowSums(select(pop_females, `5`, `6`, `7`, `8`, `9`), na.rm = TRUE),
    `10 to 14` = rowSums(select(pop_females, `10`, `11`, `12`, `13`, `14`), na.rm = TRUE),
    `15 to 19` = rowSums(select(pop_females, `15`, `16`, `17`, `18`, `19`), na.rm = TRUE),
    `20 to 24` = rowSums(select(pop_females, `20`, `21`, `22`, `23`, `24`), na.rm = TRUE),
    `25 to 29` = rowSums(select(pop_females, `25`, `26`, `27`, `28`, `29`), na.rm = TRUE),
    `30 to 34` = rowSums(select(pop_females, `30`, `31`, `32`, `33`, `34`), na.rm = TRUE),
    `35 to 39` = rowSums(select(pop_females, `35`, `36`, `37`, `38`, `39`), na.rm = TRUE),
    `40 to 44` = rowSums(select(pop_females, `40`, `41`, `42`, `43`, `44`), na.rm = TRUE),
    `45 to 49` = rowSums(select(pop_females, `45`, `46`, `47`, `48`, `49`), na.rm = TRUE),
    `50 to 54` = rowSums(select(pop_females, `50`, `51`, `52`, `53`, `54`), na.rm = TRUE),
    `55 to 59` = rowSums(select(pop_females, `55`, `56`, `57`, `58`, `59`), na.rm = TRUE),
    `60 to 64` = rowSums(select(pop_females, `60`, `61`, `62`, `63`, `64`), na.rm = TRUE),
    `65 to 69` = rowSums(select(pop_females, `65`, `66`, `67`, `68`, `69`), na.rm = TRUE),
    `70 to 74` = rowSums(select(pop_females, `70`, `71`, `72`, `73`, `74`), na.rm = TRUE),
    `75 to 79` = rowSums(select(pop_females, `75`, `76`, `77`, `78`, `79`), na.rm = TRUE),
    `80 to 84` = rowSums(select(pop_females, `80`, `81`, `82`, `83`, `84`), na.rm = TRUE),
    `over 85` = rowSums(select(pop_females, `85`:`89`, `90+`), na.rm = TRUE)
  ) %>%
  select(`lsoa_code`, lsoa_name, `00 to 04`, `05 to 09`, `10 to 14`, `15 to 19`, `20 to 24`, `25 to 29`, `30 to 34`, 
         `35 to 39`, `40 to 44`, `45 to 49`, `50 to 54`, `55 to 59`, `60 to 64`, `65 to 69`, 
         `70 to 74`, `75 to 79`, `80 to 84`, `over 85`)

pop_females <- pop_females %>%
  pivot_longer(
    cols = -c(lsoa_name, lsoa_code),
    names_to = "age",        
    values_to = "population") %>% 
  mutate(gender = "Females")

# Combine Males and Females

population_england <- bind_rows(pop_males, pop_females)

rm(pop_males, pop_females)

# Geographical Hierarchy (as of 2011)
# [Source]: https://geoportal.statistics.gov.uk/datasets/ons::lsoa-2011-to-travel-to-work-area-december-2011-exact-fit-lookup-in-the-uk/about

msoa <- read.csv(here('manchester/health/original/ons/lsoa_2011.csv'))

msoa <- msoa %>%
  select(2:7) %>%
  distinct()
# Columns: lsoa code, msoa code, lad code, lsoa name, msoa nmae, lad name

# Life Tables for England (2017-2019)
# [Source]: https://www.ons.gov.uk/peoplepopulationandcommunity/birthsdeathsandmarriages/lifeexpectancies/datasets/nationallifetablesenglandreferencetables/current
lifetable_england  <- read.csv(here('manchester/health/original/ons/life_tables_20172019.csv'),skip = 5)

# English Indices of Deprivation by LSOA (2019)
# [Source]: https://opendatacommunities.org/resource?uri=http%3A%2F%2Fopendatacommunities.org%2Fdata%2Fsocietal-wellbeing%2Fimd2019%2Findices
deprivation <- read.csv(here('manchester/health/original/ons/imd2019lsoa.csv')) 

# European Standard Population 2013
# [Source]: https://publichealthscotland.scot/services/national-data-catalogue/national-datasets/search-the-datasets/european-standard-population/#:~:text=The%20European%20Standard%20Population%20(ESP,was%20originally%20introduced%20in%201976.
european_pop <- read.csv(here('manchester/health/original/ons/european_standard_population_by_sex.csv'))

```

## Mortality rates by year of age and sex for England

The mortality rate `mx` is defined as "the number of deaths at age x
last birthday in the three year period (2017-2019) divided by the
average population at that age over the same period.

```{r}

lifetable_england <- lifetable_england[, -c(3,7,8,10)] 

mf <- rep(c("male","female"),each=4)
names1 <- rep(c("rate","denom","deaths","le"), 2)
names(lifetable_england) <- c("age",paste(mf, names1, sep="_"))

lifetable_england <- lifetable_england %>% 
  mutate(male_personyears = round(male_denom - male_deaths),
         female_personyears = round(female_denom - female_deaths)) %>% 
  select(
    age, male_denom, male_rate, male_personyears, male_le,
    female_denom, female_rate, female_personyears, female_le)

england_lifetable <- lifetable_england |>
  pivot_longer(-age, 
               names_to = c("sex","measure"),
               names_sep = "_") |>
  pivot_wider(names_from="measure", values_from=value) |>
  mutate(rate1000 = rate*1000,
         sex = factor(sex,
                      labels=stringr::str_to_title(sort(unique(.data$sex)))),
         sex = relevel(sex, "Male"))
```

## Mortality by LSOA small areas in England by sex

The age-standardized mortality rate (ASMR) (direct standarisation) is
calculated by first finding the age-specific (mortality) rates for each
age group by dividing the number of deaths by the respective population
by sex, then multiplying the result by 1000, then the sum of the product
pf each of the age-specific rates by the proportion of the population
belonging to the particular age group (standard population weight).

First for LSOAs, however, some lsoas have zero or small number of
deaths. So next step is to calculate ASMR by gender for MSOAs.

```{r}

deaths_lsoa_eng <- merge(deaths_england, population_england, by = c("lsoa_code", "lsoa_name", "gender", "age"))

# Age-specific (mortality) rates

#check <- deaths_lsoa_eng %>%
#  filter(population == 0 & deaths > 0)

#length(unique(check$lsoa_code))

#326 unique LSOAs with 0 population
#100 cases removed where pop = 0, but deaths > 0 (98 unique LSOAs)
#Note: 674 cases when there are more deaths than population across age groups

# Remove cases when population is 0 but deaths are more than 0, assign 0 ASR

deaths_lsoa_eng <- deaths_lsoa_eng %>%
  filter(!(population == 0 & deaths > 0)) %>% 
  mutate(age_specific_rate = if_else(population == 0, 0, (deaths/ population*1000)))

# Population weight for each age group within all lsoas in England. England is our reference population, since the RRs will then be multiplied by death rates by age and sex for the whole of England. 

# Using ONS reported statistics for England population estimates (add refs, mid year population 2018)

# [Source]: https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/populationestimatesforukenglandandwalesscotlandandnorthernireland

age_groups <- c("00 to 04", "05 to 09", "10 to 14", "15 to 19", "20 to 24", 
                "25 to 29", "30 to 34", "35 to 39", "40 to 44", 
                "45 to 49", "50 to 54", "55 to 59", "60 to 64", 
                "65 to 69", "70 to 74", "75 to 79", "80 to 84", 
                "85 to 89", "90+")

# Age population for females (ONS English reported population)
age_population_females <- c(1586736, 1671501, 1583573, 1519040, 1780978, 
                            1937844, 1971624, 1915382, 1737645, 
                            1948250, 1999121, 1812592, 1539980, 
                            1442042, 1410149, 994991, 780587, 
                            516960, 335578)

# Age population for males
age_population_males <- c(1670408, 1758059, 1668141, 1587797, 1779271, 
                          1847361, 1869280, 1851642, 1703652, 
                          1898976, 1943753, 1770400, 1488761, 
                          1355963, 1293965, 855145, 609495, 
                          335107, 152779)

population_england_ons <- data.frame(
  age = rep(age_groups, 2),  # Repeat age groups for both genders
  gender = rep(c("Females", "Males"), each = length(age_groups)),  # Gender labels
  age_population = c(age_population_females, age_population_males)  # Combine population data
)

population_england_ons <- population_england_ons %>%
  mutate(age = case_when(
    age %in% c("85 to 89", "90+") ~ "over 85",
    TRUE ~ age
  )) %>%
  group_by(age, gender) %>%
  summarize(age_population = sum(age_population), .groups = "drop") %>%
  ungroup()

# Calculate total population by gender
population_gender_England <- population_england_ons %>%
  group_by(gender) %>%
  summarise(gender_population = sum(age_population)) %>%# Total population by gender
  ungroup()

# Calculate age-specific population and join with gender totals
population_weights_England <- population_england_ons %>%
  select(gender, age, age_population) %>%
  group_by(gender, age) %>%
  summarise(age_population = sum(age_population)) %>% 
  ungroup() %>%
  left_join(population_gender_England, by = "gender") %>% # Join with total population by gender
  mutate(weight=age_population/gender_population)

# Now this is adding Age-standardized Rate per lsoa
# Calculate the age-standardized rate per LSOA
deaths_lsoa_eng_asdr  <- deaths_lsoa_eng %>%
  left_join(population_weights_England, by = c("age", "gender"))  %>%
  group_by(lsoa_code, lsoa_name, gender) %>%
  summarise(
    stdrate = sum(age_specific_rate * weight, na.rm = TRUE),
    population_lsoa = sum(population),
    deaths_lsoa = sum(deaths)) %>% 
  ungroup()
```

## Mortality by MSOA small areas in England by sex

```{r}

deaths_msoa <- merge(deaths_england, msoa, by.x = "lsoa_code", by.y = "LSOA11CD", all.x = TRUE)

deaths_msoa <- deaths_msoa %>% 
  select(-c(1,2,6,9,10)) %>% 
  rename("msoa_code" = "MSOA11CD",
         "msoa_name" = "MSOA11NM") %>% 
  group_by(msoa_code, msoa_name, gender, age) %>% 
  summarise(deaths = sum(deaths, na.rm = TRUE)) %>% 
  ungroup()

# Population estimates by age and sex by MSOA 

population_msoa <- merge(population_england, msoa, by.x = "lsoa_code", by.y = "LSOA11CD", all.x = TRUE)

population_msoa <- population_msoa %>% 
  select(-c(1,2,6,9,10)) %>% 
  rename("msoa_code" = "MSOA11CD",
         "msoa_name" = "MSOA11NM") %>% 
  group_by(msoa_code, msoa_name, gender, age) %>% 
  summarise(population = sum(population, na.rm = TRUE)) %>%
  ungroup()

deaths_msoa_eng <- merge(deaths_msoa, population_msoa, by = c("msoa_code", "msoa_name", "gender", "age"), all.x = TRUE)

  filter(!(population == 0 & deaths > 0)) %>% 
  mutate(age_specific_rate = if_else(population == 0, 0, (deaths/ population*1000)))
  
# Age-specific (mortality) rates
deaths_msoa_eng  <- deaths_msoa_eng  %>%
  filter(!(population == 0 & deaths > 0)) %>% 
  mutate(age_specific_rate = if_else(population == 0, 0, (deaths/ population*1000)))
  
# Population weight for each age group
deaths_msoa_eng_asdr  <- deaths_msoa_eng  %>%
  left_join(population_weights_England) %>% #added, the reference population is england
#  filter(population != 0) %>% # should not filter
  group_by(msoa_code, msoa_name, gender) %>%
  summarise(
    stdrate = sum(age_specific_rate * weight, na.rm = TRUE),
    deaths_msoa = sum(deaths)) %>%
  ungroup()

```

## Mortality by LAD areas in England by sex

We also calculate ASMR for LADs as some MSOAs might have no deaths or
small number recorded.

```{r}
deaths_lad <- merge(deaths_england, msoa, by.x = "lsoa_code", by.y = "LSOA11CD", all.x = TRUE)

deaths_lad <- deaths_lad %>% 
  select(-c(1,2,6,7,8)) %>% 
  rename("lad_code" = "LAD11CD",
         "lad_name" = "LAD11NM") %>% 
  group_by(lad_code, lad_name, gender, age) %>% 
  summarise(deaths = sum(deaths, na.rm = TRUE)) %>% 
  ungroup()

# Population estimates by age and sex by LAD 
population_lad <- merge(population_england, msoa, by.x = "lsoa_code", by.y = "LSOA11CD", all.x = TRUE)

population_lad <- population_lad %>% 
  select(-c(1,2,6,7,8)) %>% 
  rename("lad_code" = "LAD11CD",
         "lad_name" = "LAD11NM") %>% 
  group_by(lad_code, lad_name, gender, age) %>% 
  summarise(population = sum(population, na.rm = TRUE)) %>%
  ungroup()

deaths_lad_eng <- merge(deaths_lad, population_lad, by = c("lad_code", "lad_name", "gender", "age"), all.x = TRUE)

# Age-specific (mortality) crude rates
deaths_lad_eng  <- deaths_lad_eng  %>%
  filter(!(population == 0 & deaths > 0)) %>% 
  mutate(age_specific_rate = if_else(population == 0, 0, (deaths/ population*1000)))

# Age-standardized Rate
deaths_lad_eng_asdr  <- deaths_lad_eng  %>%
  left_join(population_weights_England) %>% 
#  filter(population != 0) %>%
  group_by(lad_code, lad_name, gender) %>%
  summarise(
    pop = sum(population),                       
    deaths = sum(deaths),
    stdrate = sum(age_specific_rate*weight)) %>%
  ungroup() 

# Select Manchester (this selection is for checking with other sources that record deaths at the LAD, however, these other English sources use European standard population)

deaths_lad_eng_asdr_manchester <- deaths_lad_eng_asdr %>% 
  filter(
    str_starts(lad_name, "Bolton") |
      str_starts(lad_name, "Bury") |
      str_starts(lad_name, "Manchester") |
      str_starts(lad_name, "Oldham") |
      str_starts(lad_name, "Rochdale") |
      str_starts(lad_name, "Salford") |
      str_starts(lad_name, "Stockport") |
      str_starts(lad_name, "Tameside") |
      str_starts(lad_name, "Trafford") |
      str_starts(lad_name, "Wigan"))
```

## Relative Risk by LSOA

A relative mortality rate is produced for each area (lsoa), defined as
the rate by sex for each lsoa relative to the average mortality in
England by sex**.** This average mortality is defined as a weighted
average of the area-specific rates, weighted by the population of each
area.

For future reference (
[https://pmc.ncbi.nlm.nih.gov/articles/PMC9575652](https://pmc.ncbi.nlm.nih.gov/articles/PMC9575652/))
we might want to improve the calculation of ASDR.

```{r}

england_lsoa_deaths <- deaths_lsoa_eng_asdr %>% 
  left_join(msoa, by = c("lsoa_code" = "LSOA11CD")) %>% 
  select(lsoa_code, lsoa_name, msoa_code = "MSOA11CD", lad_code = "LAD11CD",
         gender, population_lsoa, deaths_lsoa, stdrate) %>% 
  distinct() %>% 
  left_join(deaths_msoa_eng_asdr %>%  
    select(msoa_code, stdrate_msoa = stdrate, deaths_msoa, gender),
            by = c("msoa_code", "gender")) %>%
  left_join(deaths_lad_eng_asdr %>% 
    select(lad_code, stdrate_lad = stdrate, gender, deaths_lad = deaths),
            by = c("lad_code", "gender")) %>% 
  group_by(gender) %>% 
  mutate(
    # Adjust the logic to first check for deaths_lsoa and then deaths_msoa
    stdrate_selected = ifelse(
      deaths_lsoa <= 10 ,            # If LSOA deaths less than 10, use MSOA rate -
      ifelse(deaths_msoa <= 20,     # If MSOA deaths are less than 20, use LAD rate
             stdrate_lad,         
             stdrate_msoa),
      stdrate # Otherwise, use LSOA rate
    ),
    product = stdrate_selected * population_lsoa,  # Calculate product here
    stdrate_ave = sum(product, na.rm = TRUE) / sum(population_lsoa, na.rm = TRUE),  
    RR = stdrate_selected / stdrate_ave  # Calculate RR using the selected rate
  ) %>%
  ungroup()

```

Adding Index of Multiple Deprivation (IMD)

Note: for the whole of England, clear gradient on overall age and sex
standardised rates and by gender.

```{r}
# Merge with index of deprivation 

deprivation <- deprivation %>%
  filter(Indices.of.Deprivation == "a. Index of Multiple Deprivation (IMD)") %>%
  filter(Measurement == "Decile ") %>%
  mutate(deprivation="IMD") %>%
  rename(lsoa_code=FeatureCode) %>%
  select(lsoa_code, imd_decile=Value, deprivation)

```

## Overall ASR

```{r}

# Overall ASR 
england_deaths_socio <- england_lsoa_deaths %>%
  left_join(deprivation, by = "lsoa_code")

mortality_socio_all <- england_deaths_socio %>% 
  group_by(imd_decile) %>%
  summarise(
    # Only calculate the weighted mean if both rate_area_100000 and population are available
    ASR = sum(stdrate*population_lsoa, na.rm=TRUE)/sum(population_lsoa),
    .groups = "drop"
  )  %>%
  ungroup()

## Sex specific ASR

mortality_socio_gender <- england_deaths_socio %>%
  group_by(imd_decile, gender) %>%
  summarise(
    # Only calculate the weighted mean if both rate_area_100000 and population are available
    pop = sum(population_lsoa),
    deaths = sum(deaths_lsoa),
    asr = mean(stdrate),
    .groups = "drop"
  )  %>%
  ungroup()
```

## Area-specific age-standardized mortality rate

We assume that the excess mortality risk associated with living in a
particular area does not depend on age. We then estimate the
area-specific mortality rate for people of a particular age by
multiplying the mortality rate for England from life tables by the
area-specific relative risk.

```{r}
# Join with mortality data

england_lifetable <- england_lifetable %>%
  mutate(sex=as.character(sex)) %>%
  mutate(sex=case_when(sex == "Male" ~ "Males", 
                       sex == "Female" ~ "Females")) %>%
  select(age, sex, rate1000)

# Merge with deaths data with relative risks for lsoa compared with england as a whole

england_lifetable_lsoa <- england_deaths_socio %>% 
  rename (sex = gender) %>% 
  cross_join(england_lifetable) %>% 
  filter(sex.x == sex.y) %>%
  mutate(rate1000=rate1000*RR) %>%
  select(lsoa_code, lsoa_name, sex = sex.x, age, rate1000, imd_decile, population_lsoa,RR)

# Filter for Greater Manchester Only:

manchester_lifetable_lsoa <- england_lifetable_lsoa %>% 
  filter(
    str_starts(lsoa_name, "Bolton") |
      str_starts(lsoa_name, "Bury") |
      str_starts(lsoa_name, "Manchester") |
      str_starts(lsoa_name, "Oldham") |
      str_starts(lsoa_name, "Rochdale") |
      str_starts(lsoa_name, "Salford") |
      str_starts(lsoa_name, "Stockport") |
      str_starts(lsoa_name, "Tameside") |
      str_starts(lsoa_name, "Trafford") |
      str_starts(lsoa_name, "Wigan")) %>%
  mutate(rate=rate1000/1000)

write.csv(manchester_lifetable_lsoa, here("manchester/health/processed/manchester_mortality_lsoa.csv"))

# Graph death rates england

library(viridis)  # For better color scaling


### Graph for England
# imd_decile is a factor

data_plot <- england_lifetable_lsoa %>%
  mutate(
    imd_decile = as.factor(imd_decile),  # Ensure imd_decile is a factor
    rate1000 = ifelse(rate1000 == 0, 0.00000000001, rate1000)  # Replace zeros in rate1000
  )

p_england <- ggplot(data_plot, 
                    aes(x = age, y = rate1000,
                        col = imd_decile,  # Color by IMD decile
                        group = lsoa_code)) +  # Each LSOA has its own line
  geom_line(lwd = 0.7, alpha = 0.5) +  # Reduce opacity to manage overplotting
  facet_wrap(~ sex) +  # Compare IMD deciles within each sex
  ylab("Mortality rate (per 1000)") + 
  xlab("Age (years)") +  
  scale_y_continuous(trans="log", 
                     breaks=c(0.0002, 0.0005, 0.001, 0.005, 0.01, 0.05, 0.1, 0.2)*1000) +
  scale_color_viridis_d(option = "C", name = "IMD Decile") +  # Use discrete color scale
  theme_minimal(base_size = 14) +  
  theme(
    strip.text = element_text(face = "bold"),
    legend.position = "bottom"  # Move legend for readability
  ) +
  ggtitle("Death rates England")  # Add title

# Print the plot
print(p_england)


# Graph death rates Manchester

data_plot <- manchester_lifetable_lsoa %>%
  mutate(
    imd_decile = as.factor(imd_decile),  # Ensure imd_decile is a factor
    rate1000 = ifelse(rate1000 == 0, 0.00000000001, rate1000)  # Replace zeros in rate1000
  )

p_manchester <- ggplot(data_plot, 
                    aes(x = age, y = rate1000,
                        col = imd_decile,  # Color by IMD decile
                        group = lsoa_code)) +  # Each LSOA has its own line
  geom_line(lwd = 0.7, alpha = 0.5) +  # Reduce opacity to manage overplotting
  facet_wrap(~ sex) +  # Compare IMD deciles within each sex
  ylab("Mortality rate (per 1000)") + 
  xlab("Age (years)") +  
    scale_y_continuous(trans="log", 
                     breaks=c(0.0002, 0.0005, 0.001, 0.005, 0.01, 0.05, 0.1, 0.2)*1000) +
  scale_color_viridis_d(option = "C", name = "IMD Decile") +  # Use discrete color scale
  theme_minimal(base_size = 14) +  
  theme(
    strip.text = element_text(face = "bold"),
    legend.position = "bottom"  # Move legend for readability
  )  +
  ggtitle("Death rates Greater Manchester")  # Add title

# Print the plot
print(p_manchester)

# RR plots for Manchester

manchester_deaths_socio <- england_deaths_socio %>% 
  filter(
    str_starts(lsoa_name, "Bolton") |
      str_starts(lsoa_name, "Bury") |
      str_starts(lsoa_name, "Manchester") |
      str_starts(lsoa_name, "Oldham") |
      str_starts(lsoa_name, "Rochdale") |
      str_starts(lsoa_name, "Salford") |
      str_starts(lsoa_name, "Stockport") |
      str_starts(lsoa_name, "Tameside") |
      str_starts(lsoa_name, "Trafford") |
      str_starts(lsoa_name, "Wigan"))

rr_plot <- ggplot(manchester_deaths_socio, aes(x = imd_decile, y = RR, color = as.factor(imd_decile))) +
  geom_point(alpha = 0.7, size = 3) +  # Add points with transparency and size
  geom_smooth(method = "lm", se = FALSE, aes(group = 1), color = "blue") +  # Add a linear regression line
  scale_x_continuous(breaks = 1:10) +  # Set x-axis breaks for IMD deciles
  labs(
    title = "Relative Mortality Risk for LSOA by Deprivation Decile, Manchester (2016-2019)",
    x = "Deprivation Decile (1 - Most Deprived, 10 - Least Deprived)",
    y = "Relative Mortality Risk (RR)",
    color = "Deprivation Decile"
  ) +
  theme_minimal() +
  theme(
    panel.grid.minor = element_blank(),
    legend.position = "bottom"
  ) +
  theme(legend.title = element_text(face = "bold"), legend.text = element_text(size = 10))


rr_plot


### Comparison of age standardised rates with ONS data by LAD and our calculations but using weight from the European standard population. We use European standard population to compare because ASDR per LAD from ONS use this weights in their calculations.  

### European Standard Population 2013

european_pop <- european_pop %>%
  mutate(Sex = ifelse(Sex == "Male", "Males", "Females")) %>%
  rename(
    "age" = "AgeGroup",
    "gender" = "Sex",
    "population" = "EuropeanStandardPopulation"
  ) %>%
  mutate(age = case_when(
    age == "90plus years" | age == "85-89 years" ~ "over 85",
    TRUE ~ str_replace(age, "(\\d+)-(\\d+)", "\\1 to \\2")
  )) %>%
  mutate(age = str_replace_all(age, "\\b(\\d)\\b", "0\\1")) %>%
  mutate(age = str_replace(age, " years", "")) %>%  # Remove 'years'
  mutate(age = ifelse(age == "00 to 04", "01 to 04", age)) %>%  # Rename '00 to 04'
  group_by(age, gender) %>%
  summarise(population = sum(population), .groups = 'drop')


# Calculate age-specific population and join with gender totals
population_weights_europe <- european_pop %>%
  select(gender, age, population) %>%
  group_by(gender, age) %>%
  summarise(age_population = sum(population)) %>%  # Total population by gender and age
  ungroup() %>%
  mutate(weight=age_population/100000)

# lsoa
deaths_lsoa_eng_eu  <- deaths_lsoa_eng %>%
  left_join(population_weights_europe, by = c("age", "gender")) %>%
  group_by(lsoa_code, lsoa_name, gender) %>%
  filter(population != 0) %>%
  summarise(
    stdrate = sum(age_specific_rate * weight, na.rm = TRUE),
    population_lsoa = sum(population),
    deaths_lsoa = sum(deaths))

#msoa
deaths_msoa_eng_eu  <- deaths_msoa_eng  %>%
  left_join(population_weights_europe, by = c("age", "gender")) %>%
  filter(population != 0) %>%
  group_by(msoa_code, msoa_name, gender) %>%
  summarise(
    stdrate = sum(age_specific_rate * weight, na.rm = TRUE),
    deaths_msoa = sum(deaths)) %>%
  ungroup()

#lad
deaths_lad_eng_eu  <- deaths_lad_eng  %>%
  left_join(population_weights_europe, by = c("age", "gender")) %>%
  filter(population != 0) %>%
  group_by(lad_code, lad_name, gender) %>%
  summarise(
    stdrate = sum(age_specific_rate*weight,  na.rm = TRUE)) %>%
  ungroup()

#Filter for Manchester only
deaths_lad_eu_asdr_manchester <- deaths_lad_eng_eu %>% 
  filter(
    str_starts(lad_name, "Bolton") |
      str_starts(lad_name, "Bury") |
      str_starts(lad_name, "Manchester") |
      str_starts(lad_name, "Oldham") |
      str_starts(lad_name, "Rochdale") |
      str_starts(lad_name, "Salford") |
      str_starts(lad_name, "Stockport") |
      str_starts(lad_name, "Tameside") |
      str_starts(lad_name, "Trafford") |
      str_starts(lad_name, "Wigan"))

######## Compare all three ##################

# Insert ONS data

ons_males <- data.frame(
  lad_name = c("Bolton", "Bury", "Manchester", "Oldham", "Rochdale", 
               "Salford", "Stockport", "Tameside", "Trafford", "Wigan"),
  gender = "Males",
  stdrate = c(1251.24, 1167.21, 1411.85, 1203.00, 1292.55, 
              1307.56, 1089.01, 1408.41, 1035.49, 1265.22))

ons_females <- data.frame(
  lad_name = c("Bolton", "Bury", "Manchester", "Oldham", "Rochdale", 
               "Salford", "Stockport", "Tameside", "Trafford", "Wigan"),
  gender = "Females",
  stdrate = c(954.82, 889.87, 1055.58, 983.05, 973.23, 
              1063.41, 800.01, 1150.26, 753.01, 1023.83)
)

ons <- bind_rows(ons_males,ons_females) %>% 
  mutate(stdrate = stdrate/100,
         source = "ONS") 

check <- ons %>% 
  left_join(deaths_lad_eng_asdr_manchester %>% 
              mutate(source = "England Population") %>% 
              select(lad_name, gender, stdrate_eng = stdrate, source), by = c("gender", "lad_name")) %>% 
  left_join(deaths_lad_eu_asdr_manchester %>% 
             mutate(source = "European Population") %>% 
              select(lad_name, gender, stdrate_eu = stdrate, source), by = c("gender", "lad_name"))

##### End of comparison ###########

england_lsoa_deaths_eu <- deaths_lsoa_eng_eu |>
  left_join(msoa, join_by(lsoa_code == LSOA11CD)) |>
  select(lsoa_code, lsoa_name, msoa_code = "MSOA11CD", lad_code = "LAD11CD",gender,population_lsoa, deaths_lsoa, stdrate) |>
  distinct() |>
  left_join(deaths_msoa_eng_eu |> select(msoa_code, stdrate_msoa = stdrate, deaths_msoa,gender), by= c("msoa_code","gender")) |>
  left_join(deaths_lad_eng_eu |> select(lad_code, stdrate_lad = stdrate,gender), by=c("lad_code","gender")) %>%
  group_by (gender) %>%
  # Use MSOA rate if LSOA std rate is missing or has fewer than 10 deaths, and use LAD if msoa deaths are fewer than 20
  mutate(stdrate_ave = with(.data, sum(stdrate*population_lsoa,na.rm = TRUE)/sum(population_lsoa)),
         stdrate = ifelse(
           is.na(stdrate) | deaths_lsoa < 10,   # if NA or fewer than 10 deaths at the lsoa level, use msoa
           ifelse(
             deaths_msoa > 20,             # if fewer than 20 deaths at the msoa level, use lad
             stdrate_msoa,
             stdrate_lad),
           stdrate)) |>                    # if not NA and more than or equal to 10, use lsoa
  mutate(RR = stdrate / stdrate_ave)

# Adding level of deprivation

england_deaths_socio_eu <- england_lsoa_deaths_eu %>%
  left_join(deprivation, by = "lsoa_code")

# For All
mortality_socio_all_eu <- england_deaths_socio_eu %>%
  group_by(imd_decile) %>%
  summarise(
    # Only calculate the weighted mean if both rate_area_100000 and population are available
    ASR = sum(stdrate*population_lsoa, na.rm=TRUE)/sum(population_lsoa),
    .groups = "drop"
  )  %>%
  ungroup()

### Sex specific ASR

mortality_socio_gender_eu <- england_deaths_socio_eu %>%
  group_by(imd_decile, gender) %>%
  summarise(
    # Only calculate the weighted mean if both rate_area_100000 and population are available
    ASR = sum(stdrate*population_lsoa, na.rm=TRUE)/sum(population_lsoa),
    .groups = "drop"
  )  %>%
  ungroup()

# lad of Greater Manchester Only

deaths_lad_man_eu <- deaths_lad_eng_eu %>%
  filter(
    str_starts(lad_name, "Bolton") |
      str_starts(lad_name, "Bury") |
      str_starts(lad_name, "Manchester") |
      str_starts(lad_name, "Oldham") |
      str_starts(lad_name, "Rochdale") |
      str_starts(lad_name, "Salford") |
      str_starts(lad_name, "Stockport") |
      str_starts(lad_name, "Tameside") |
      str_starts(lad_name, "Trafford") |
      str_starts(lad_name, "Wigan"))

deaths_lad_man_eng <- deaths_lad_eng_asdr %>%
  filter(
    str_starts(lad_name, "Bolton") |
      str_starts(lad_name, "Bury") |
      str_starts(lad_name, "Manchester") |
      str_starts(lad_name, "Oldham") |
      str_starts(lad_name, "Rochdale") |
      str_starts(lad_name, "Salford") |
      str_starts(lad_name, "Stockport") |
      str_starts(lad_name, "Tameside") |
      str_starts(lad_name, "Trafford") |
      str_starts(lad_name, "Wigan"))
```

# Disease Incidence

## Data Sources

```{r include = FALSE}
# GBD data for Manchester 
gbd <- bind_rows(
  read.csv(here("manchester/health/original/GBD/IHME-GBD_2021_data-bfdf8007-1.csv")), 
  read.csv(here("manchester/health/original/gbd/IHME-GBD_2021_DATA-125d4b23-1.csv")), 
  read.csv(here("manchester/health/original/gbd/IHME-GBD_2021_DATA-1316cd33-1.csv")),
  read.csv(here("manchester/health/original/gbd/IHME-GBD_2021_DATA-cffadb37-1.csv")),
  read.csv(here("manchester/health/original/gbd/IHME-GBD_2021_DATA-131cf659-1.csv")),
  read.csv(here("manchester/health/original/gbd/IHME-GBD_2021_DATA-4fbe0549-1.csv")), 
  read.csv(here("manchester/health/original/gbd/parkinsons1.csv")),
  read.csv(here("manchester/health/original/gbd/parkinsons3.csv")))

# Filter data to needed variables and remove strings from GBD age variable and create from_age and to_age needed for interpolation. 

gbdp <- gbd %>%
  filter(metric %in% "Rate") %>%
  select(-c(upper, lower)) %>%
  filter(!age %in% "All ages") %>%
  mutate(rate_1=val/100000) %>% 
  # some ages have 'years' (eg 5-9 years), while others don't (eg 80-84); omit 'years'
  mutate(age = gsub(" years", "", age)) %>%
  tidyr::extract(age, c("from_age", "to_age"), "(.+)-(.+)", remove=FALSE, convert=TRUE) %>%
  mutate(from_age = case_when(age=="95+"  ~  95L,
                              age=="<5"  ~  0L,
                              TRUE  ~  from_age),
         to_age = case_when(age=="95+"  ~  99L,
                            age=="<5"  ~  4L,
                            TRUE  ~  to_age),
         agediff = to_age - from_age + 1,
         val1yr = rate_1) %>% 
  #we do not distribute among age groups as it is a rate but assume same within age group
  rename(agegroup = age) 

# Data preparation to match diseases and names from Cambridge physical activity meta-analysis

# Some specific cancers need adjustment to match GBD data to standardised JIBE disease list.

gbdp <- gbdp %>%
  filter (cause %in% c("Stroke", "Ischemic heart disease", "Breast cancer", 
                       "Uterine cancer", "Tracheal, bronchus, and lung cancer", 
                       "Colon and rectum cancer", "Esophageal cancer", 
                       "Liver cancer",  
                       "Stomach cancer", "Chronic myeloid leukemia", "Multiple myeloma", 
                       "Larynx cancer", "Lip and oral cavity cancer", "Nasopharynx cancer",
 "Other pharynx cancer", "Bladder cancer",  
                        "Depressive disorders",  "Alzheimer's disease and other dementias", 
                       "Diabetes mellitus type 2", "Chronic obstructive pulmonary disease", "Parkinson's disease")) %>%
  mutate(cause = case_when(
    cause == "Ischemic heart disease"    ~ "coronary_heart_disease",
    cause == "Uterine cancer"            ~ "endometrial_cancer",
    cause == "Stomach cancer"            ~ "gastric_cardia_cancer",
    cause == "Chronic myeloid leukemia"  ~ "myeloid_leukemia",
    cause == "Multiple myeloma"          ~ "myeloma",
    cause == "Depressive disorders" ~ "depression",
    cause == "Alzheimer's disease and other dementias" ~ "all_cause_dementia",
    cause == "Diabetes mellitus type 2"  ~ "diabetes",
    cause == "Stroke" ~ "stroke", 
    cause == "Tracheal, bronchus, and lung cancer" ~ "lung_cancer", 
    cause == "Breast cancer" ~ "breast_cancer", 
    cause == "Colon and rectum cancer" ~ "colon_cancer", 
    cause == "Bladder cancer" ~ "bladder_cancer", 
    cause == "Esophageal cancer" ~ "esophageal_cancer",
    cause == "Liver cancer" ~ "liver_cancer", 
    cause == "Chronic obstructive pulmonary disease" ~ "COPD",
    cause == "Parkinson's disease"  ~ "parkinson’s_disease",
    .default = cause))


# Sum rates for head an neck cancers
hanc <- c("Larynx cancer", "Lip and oral cavity cancer", "Nasopharynx cancer",
          "Other pharynx cancer")

gbdp_hanc <- gbdp %>%
  filter(cause %in% hanc) %>%
  group_by(measure, location, sex, agegroup, from_age, to_age, metric, year, agediff) %>%
  summarise(val = sum(val),
            rate_1 = sum(rate_1),
            val1yr = sum(val1yr),.groups = "drop") %>%
  mutate(cause = "head_and_neck_cancer") %>% 
  select(1:6,13,7,8,10,11,9,12)

gbdp <- gbdp %>%
  filter(!cause %in% hanc) %>%
  bind_rows(gbdp_hanc) 
```

## Interpolation

```{r}
# Now stretch the data out using an index, to create a data frame with 1 row per year of age and create a variable for year of age. 
# The age group rate repeats within single years of age in the group. 
index <- rep(1:nrow(gbdp), gbdp$agediff)
gbdpyrd5 <- gbdp[index,] %>%
  mutate(ageyr = from_age + sequence(gbdp$agediff) - 1)
gbdpyrd5 <- gbdpyrd5 %>% 
  select(measure, ageyr, sex, agegroup, from_age, to_age, cause, year, val1yr,rate_1, location)

# Apply the disaggregation function

# Group data for dissaggregation

gbdp_grp <- gbdp %>%
  group_by(measure, year, sex, cause, location) %>%
  arrange(measure, year, sex, cause, from_age)

# Apply function (select a function from 'functions/interpolation.R'). Smooth_spline does a good job.
gbdpyr_interp <- group_modify(gbdp_grp, disagg_smooth_spline) %>%
  ungroup()

# Filter the rows where ageyr is 95
age_95_data <- gbdpyr_interp %>% filter(ageyr == 95)

# Create new rows for ageyr 96 to 100, repeating the values for val_interpolated
new_rows <- age_95_data %>%
  mutate(ageyr = list(96:100)) %>%
  unnest(ageyr) 

# Combine the original data frame with the new rows
gbdpyr_interp <- bind_rows(gbdpyr_interp, new_rows)

# Add LAD code
lad <- read.csv(here('manchester/health/original/ons/lsoa_to_msoa.csv'))
lad <- lad %>%
  select(6,7) %>%
  distinct()

gbdpyr_interp <- gbdpyr_interp %>%
  left_join(lad, by = c("location" = "LAD20NM"))


write.csv(gbdpyr_interp, here("manchester/health/processed/manchester_diseases_lad.csv"))

#Join with original data where rates are the same within groups to validate interpolated data
gbdpyr_interp <- gbdpyr_interp %>%
  left_join(gbdpyrd5, by = c("measure", "year", "ageyr", "sex", "cause", "location"))


### Below takes a long time, unless somethings changes, once graphs generated, no need to run again. 
# Plot data to check interpolated values against 5-year age group values (original data)
## Four interpolation function could be use, the best fit should be used. For now, best fit to the data assessed visually.

# # Melt the data to long format for ggplot
# plot_data <- gbdpyr_interp %>%
#   select(measure, cause, sex, ageyr, rate_1, val_interpolated, location) %>%
#   pivot_longer(cols = c(rate_1, val_interpolated), names_to = "type", values_to = "value")
# 
# # Define output directory
# output_dir <- "images/manchester/inc_gbd_age_sex/"
# if (!dir.exists(output_dir)) {
#   dir.create(output_dir, recursive = TRUE)
# }
# 
# # Get unique combinations of measure, cause, sex, and location
# combinations <- plot_data %>%
#   distinct(measure, cause, sex, location)
# 
# # Generate and save plots for each combination
# for (i in 1:nrow(combinations)) {
#   subset_df <- plot_data %>%
#     filter(measure == combinations$measure[i],
#            cause == combinations$cause[i],
#            sex == combinations$sex[i],
#            location == combinations$location[i])
#   p <- ggplot(subset_df, aes(x = ageyr, y = value, color = type)) +
#     geom_line() +
#     labs(title = paste("Measure:", combinations$measure[i], 
#                        "Cause:", combinations$cause[i], 
#                        "Sex:", combinations$sex[i],
#                        "Location:", combinations$location[i]),
#          x = "Age (years)",
#          y = "Value") +
#     theme_minimal(base_family = "Arial") +
#     theme(panel.background = element_rect(fill = "white", color = "white"),
#           plot.background = element_rect(fill = "white", color = "white"))
# # Save the plot
#   ggsave(filename = paste0(output_dir, "plot_", i, ".png"), plot = p, width = 8, height = 6)
# }
```

# Combining All-cause Mortality and Disease Incidence Data

```{r}

diseases <- read.csv(here("manchester/health/processed/manchester_diseases_lad.csv"))
allcause <- read.csv(here("manchester/health/processed/manchester_mortality_lsoa.csv"))

# Process data 

allcause_data <- allcause %>%
  mutate(cause = "all_cause_mortality",
         measure = "deaths") %>%  
  rename(location_code = lsoa_code,
         location_name = lsoa_name) %>%
  mutate(location_type="lsoa") %>%
  mutate(sex=as.numeric(case_when(sex == "Males" ~ 1,
                                  sex=="Females" ~ 2))) %>%
  select(age, sex, location_code, location_type, cause, rate, measure)

diseases_data <- diseases %>% 
  filter(year == 2018) %>% 
  mutate(measure = tolower(measure),
         cause = tolower(cause),
         socio = NA) %>% 
  rename(location_code = LAD20CD,
         location_name = location,
         age = ageyr,
         rate = val_interpolated) %>%
  mutate(location_type="lad")  %>%
  mutate(sex=as.numeric(case_when(sex == "Male" ~ 1,
                                  sex=="Female" ~ 2))) %>%
  select(age, sex,location_code, location_type, cause, rate, measure)

incidence <- diseases_data %>% filter(measure == "incidence")

prevalence <- diseases_data %>% filter(measure == "prevalence")


health_transitions_manchester <- bind_rows(allcause_data, incidence)

# Save prevalence and incidence (includes deaths from all causes) separetly


write.csv(prevalence, here("manchester/health/processed/health_transitions_manchester_prevalence.csv"))

write.csv(health_transitions_manchester, here("manchester/health/processed/health_transitions_manchester_raw.csv"))
```
